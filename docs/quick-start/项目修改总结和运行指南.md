# KV存储RAFT项目修改总结和运行指南

## 一、项目修改逻辑链条

### 1. 新增文件

#### 1.1 `simple_stress_test.cpp` - 压力测试程序
**位置**: 项目根目录
**设计目的**: 模拟CPU密集型操作，为perf性能分析提供测试目标
**核心功能**:
- `SimpleStressTester` 类：压力测试器
- `WorkerThread()` 方法：工作线程执行CPU密集型操作
- 多线程并发（4个线程，每个1000次操作）
- 包含随机数生成、内存操作、字符串处理

#### 1.2 `kv_raft_performance_analysis.md` - 性能分析报告
**位置**: 项目根目录
**设计目的**: 记录完整的性能分析流程和结果
**核心内容**:
- 项目结构分析
- 现有测试用例总结
- perf火焰图生成流程
- 性能测试结果
- 优化建议

#### 1.3 `FlameGraph/` 目录 - 火焰图工具
**位置**: 项目根目录
**设计目的**: 提供火焰图生成工具
**核心工具**:
- `stackcollapse-perf.pl`: 折叠调用栈
- `flamegraph.pl`: 生成SVG火焰图

### 2. 生成的文件

#### 2.1 性能数据文件
- `perf.data`: 原始性能采样数据
- `perf.unfold`: 未折叠的调用栈信息
- `perf.folded`: 折叠后的调用栈数据
- `perf.svg`: 最终火焰图（可在浏览器中查看）

## 二、项目重新了解指南

### 1. 项目核心架构

#### 1.1 主要组件目录结构
```
src/
├── raftCore/          # RAFT共识算法核心实现
├── skipList/          # 跳表KV存储数据结构
├── rpc/               # RPC通信框架
├── fiber/             # 协程调度器
├── raftClerk/         # RAFT客户端
└── common/            # 公共工具
```

#### 1.2 关键文件分析

**RAFT核心实现** (`src/raftCore/`)
- `raft.cpp`: RAFT状态机实现
- `kvServer.cpp`: KV服务器封装
- `Persister.cpp`: 持久化存储

**跳表实现** (`src/skipList/`)
- 提供高效的KV存储数据结构
- 支持O(log n)时间复杂度的插入、查找、删除

**RPC框架** (`src/rpc/`)
- `mprpcchannel.cpp`: RPC通道实现
- `rpcprovider.cpp`: RPC服务提供者
- 基于protobuf的序列化

### 2. 现有测试用例

#### 2.1 基础测试 (`test/`)
- `run.cpp`: 主要测试运行入口
- `defer_run.cpp`: 延迟执行测试
- `format.cpp`: 格式化功能测试

#### 2.2 示例程序 (`example/`)
- `raftCoreExample/`: RAFT核心功能演示
- `rpcExample/`: RPC通信示例
- `fiberExample/`: 协程调度示例

## 三、perf火焰图运行详细指南

### 1. 环境准备（已完成）

```bash
# 1. 安装perf工具（已完成）
sudo apt install linux-tools-common linux-tools-generic

# 2. 克隆FlameGraph工具（已完成）
git clone https://github.com/brendangregg/FlameGraph.git
```

### 2. 编译压力测试程序

```bash
# 编译简单的压力测试程序
g++ -std=c++17 -pthread simple_stress_test.cpp -o bin/simple_stress_test

# 如果要编译项目本身的测试程序，可以使用CMake
cd build
cmake ..
make
```

### 3. 运行perf性能分析（完整流程）

#### 3.1 第一步：采集性能数据
```bash
# 使用perf record记录性能数据
# -F 99: 设置采样频率为99Hz
# -g: 启用调用图记录
perf record -F 99 -g ./bin/simple_stress_test
```

**参数解释**:
- `-F 99`: 每秒采样99次，避免采样过多影响性能
- `-g`: 记录完整的调用栈信息，用于生成火焰图
- `./bin/simple_stress_test`: 要分析的目标程序

#### 3.2 第二步：提取调用栈信息
```bash
# 将二进制性能数据转换为文本格式
perf script -i perf.data > perf.unfold
```

**文件说明**:
- `perf.unfold`: 包含每次采样的完整调用栈信息
- 格式：时间戳、进程ID、线程ID、函数调用链

#### 3.3 第三步：折叠调用栈
```bash
# 使用FlameGraph工具折叠调用栈
./FlameGraph/stackcollapse-perf.pl perf.unfold > perf.folded
```

**处理逻辑**:
- 将相同的调用栈合并
- 统计每个调用栈的出现次数
- 生成适合火焰图的格式

#### 3.4 第四步：生成火焰图
```bash
# 生成SVG格式的火焰图
./FlameGraph/flamegraph.pl perf.folded > perf.svg
```

**输出文件**:
- `perf.svg`: 可交互的火焰图
- 可以在浏览器中打开查看

### 4. 查看和分析火焰图

#### 4.1 打开火焰图
```bash
# 在浏览器中打开火焰图
firefox perf.svg
# 或者
google-chrome perf.svg
```

#### 4.2 火焰图解读方法

**颜色含义**:
- 不同颜色代表不同的函数或库
- 暖色调（红、橙）通常表示热点函数

**宽度含义**:
- 每个矩形的宽度代表该函数在采样中出现的比例
- 越宽的函数占用CPU时间越多

**高度含义**:
- 调用栈的深度，上层调用下层
- 最底层是入口函数，最顶层是叶子函数

**交互功能**:
- 鼠标悬停：显示函数名和采样比例
- 点击放大：查看特定区域的详细信息
- 搜索功能：查找特定函数

### 5. 针对KV存储RAFT项目的具体分析步骤

#### 5.1 分析RAFT核心性能
```bash
# 1. 启动RAFT服务器集群
./bin/raft_server --config=test.conf

# 2. 在另一个终端运行perf分析
perf record -F 99 -g -p <raft_server_pid> -- sleep 30

# 3. 生成火焰图（同上流程）
```

#### 5.2 分析KV操作性能
```bash
# 1. 运行KV压力测试
./bin/kv_stress_test --threads=8 --operations=10000

# 2. 同时采集性能数据
perf record -F 99 -g ./bin/kv_stress_test

# 3. 生成火焰图分析热点
```

### 6. 高级perf使用技巧

#### 6.1 指定特定事件
```bash
# 只分析CPU周期
perf record -e cycles -g ./bin/simple_stress_test

# 分析缓存未命中
perf record -e cache-misses -g ./bin/simple_stress_test

# 分析分支预测失败
perf record -e branch-misses -g ./bin/simple_stress_test
```

#### 6.2 实时监控
```bash
# 实时查看性能热点
perf top

# 监控特定进程
perf top -p <pid>
```

#### 6.3 统计模式
```bash
# 统计模式，不记录详细调用栈
perf stat ./bin/simple_stress_test

# 统计特定事件
perf stat -e cycles,cache-misses,branch-misses ./bin/simple_stress_test
```

## 四、常见问题解决

### 1. 权限问题
```bash
# 如果遇到权限错误，可能需要调整内核参数
echo 0 | sudo tee /proc/sys/kernel/perf_event_paranoid
echo 0 | sudo tee /proc/sys/kernel/kptr_restrict
```

### 2. 符号解析问题
```bash
# 编译时添加调试信息
g++ -g -O2 -std=c++17 -pthread simple_stress_test.cpp -o bin/simple_stress_test
```

### 3. 采样数据太少
```bash
# 增加采样时间或频率
perf record -F 199 -g ./bin/simple_stress_test
# 或者运行更长时间的压力测试
```

## 五、下一步建议

### 1. 集成到开发流程
- 将perf分析集成到CI/CD流水线
- 设置性能基准测试
- 监控性能回归

### 2. 深入分析方向
- 内存性能分析：`perf mem`
- I/O性能分析：`perf trace`
- 锁竞争分析：`perf lock`

### 3. 优化策略
- 根据火焰图识别热点函数
- 优化算法复杂度
- 减少不必要的锁竞争
- 优化内存访问模式
