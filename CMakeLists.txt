# è®¾ç½®cmakeçš„æœ€ä½ç‰ˆæœ¬å’Œé¡¹ç›®åç§°
cmake_minimum_required(VERSION 3.22)
project(KVRaftCpp)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
# ç”Ÿæˆdebugç‰ˆæœ¬ï¼Œå¯ä»¥è¿›è¡Œgdbè°ƒè¯•
set(CMAKE_BUILD_TYPE "Debug")

# ==================== spdlog ä¾èµ– ====================
# ç›´æ¥ä½¿ç”¨ FetchContent ä¸‹è½½ spdlogï¼Œé¿å…ç³»ç»Ÿç‰ˆæœ¬å†²çª
message(STATUS "ğŸ“¥ Downloading spdlog from GitHub...")
include(FetchContent)
FetchContent_Declare(
    spdlog
    GIT_REPOSITORY https://github.com/gabime/spdlog.git
    GIT_TAG v1.12.0
    GIT_SHALLOW TRUE
)
FetchContent_MakeAvailable(spdlog)

# å°† spdlog çš„å¤´æ–‡ä»¶è·¯å¾„æ·»åŠ åˆ°å…¨å±€includeè·¯å¾„
get_target_property(SPDLOG_INCLUDE_DIRS spdlog::spdlog INTERFACE_INCLUDE_DIRECTORIES)
include_directories(${SPDLOG_INCLUDE_DIRS})
message(STATUS "âœ… spdlog configured, include dirs: ${SPDLOG_INCLUDE_DIRS}")
# ==================== spdlog é…ç½®ç»“æŸ ====================

# ==================== å‹ç¼©åº“æ£€æµ‹ ====================
# å°è¯•æŸ¥æ‰¾ LZ4 å’Œ Zstd å‹ç¼©åº“
# å¦‚æœæ‰¾ä¸åˆ°ï¼Œä¼šä½¿ç”¨å ä½å®ç°ï¼ˆæ€§èƒ½è¾ƒå·®ä½†èƒ½ç¼–è¯‘é€šè¿‡ï¼‰

# æŸ¥æ‰¾ LZ4
find_path(LZ4_INCLUDE_DIR lz4.h)
find_library(LZ4_LIBRARY lz4)

if(LZ4_INCLUDE_DIR AND LZ4_LIBRARY)
    message(STATUS "âœ… Found LZ4: ${LZ4_LIBRARY}")
    add_definitions(-DHAVE_LZ4)
    set(COMPRESSION_LIBRARIES ${COMPRESSION_LIBRARIES} ${LZ4_LIBRARY})
    include_directories(${LZ4_INCLUDE_DIR})
else()
    message(WARNING "âš ï¸ LZ4 not found, using dummy implementation. Install: sudo apt install liblz4-dev")
endif()

# æŸ¥æ‰¾ Zstd
find_path(ZSTD_INCLUDE_DIR zstd.h)
find_library(ZSTD_LIBRARY zstd)

if(ZSTD_INCLUDE_DIR AND ZSTD_LIBRARY)
    message(STATUS "âœ… Found Zstd: ${ZSTD_LIBRARY}")
    add_definitions(-DHAVE_ZSTD)
    set(COMPRESSION_LIBRARIES ${COMPRESSION_LIBRARIES} ${ZSTD_LIBRARY})
    include_directories(${ZSTD_INCLUDE_DIR})
else()
    message(WARNING "âš ï¸ Zstd not found, using dummy implementation. Install: sudo apt install libzstd-dev")
endif()

message(STATUS "==================== Compression Libraries ====================")
message(STATUS "LZ4: ${LZ4_LIBRARY}")
message(STATUS "Zstd: ${ZSTD_LIBRARY}")
message(STATUS "Total compression libs: ${COMPRESSION_LIBRARIES}")
message(STATUS "================================================================")
# ==================== å‹ç¼©åº“æ£€æµ‹ç»“æŸ ====================

# è®¾ç½®é¡¹ç›®å¯æ‰§è¡Œæ–‡ä»¶è¾“å‡ºçš„è·¯å¾„
set(EXECUTABLE_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/bin)
# è®¾ç½®é¡¹ç›®åº“æ–‡ä»¶è¾“å‡ºçš„è·¯å¾„
set(LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/lib)

# è®¾ç½®é¡¹ç›®ç¼–è¯‘å¤´æ–‡ä»¶æœç´¢è·¯å¾„ -I
# ç›®å‰å¯èƒ½å­˜åœ¨è·¯å¾„æ±¡æŸ“çš„é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥è§£å†³
include_directories(${PROJECT_SOURCE_DIR}/src/common/include)
include_directories(${PROJECT_SOURCE_DIR}/src/fiber/include)
include_directories(${PROJECT_SOURCE_DIR}/src/rpc/include)
include_directories(${PROJECT_SOURCE_DIR}/example)
include_directories(${PROJECT_SOURCE_DIR}/src/raftCore/include)
include_directories(${PROJECT_SOURCE_DIR}/src/raftRpcPro/include)
include_directories(${PROJECT_SOURCE_DIR}/src/raftClerk/include)
include_directories(${PROJECT_SOURCE_DIR}/src/skipList/include)


# è®¾ç½®é¡¹ç›®åº“æ–‡ä»¶æœç´¢è·¯å¾„ -L
link_directories(${PROJECT_SOURCE_DIR}/lib)

# srcåŒ…å«äº†æ‰€æœ‰çš„ç›¸å…³ä»£ç 
add_subdirectory(src)
# exampleåŒ…å«äº†ä½¿ç”¨çš„ç¤ºä¾‹ä»£ç 
add_subdirectory(example)

add_library(skip_list_on_raft STATIC  ${src_rpc} ${src_fiber} ${rpc_example} ${raftsource} ${src_raftCore} ${src_raftRpcPro})
target_link_libraries(skip_list_on_raft muduo_net muduo_base pthread dl ${COMPRESSION_LIBRARIES} spdlog::spdlog)
# æ·»åŠ æ ¼å¼åŒ–ç›®æ ‡ start
# from : https://blog.csdn.net/guotianqing/article/details/121661067

add_custom_target(format
        COMMAND bash ${PROJECT_SOURCE_DIR}/format.sh
        WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
        COMMAND echo "format done!"
)


# æ·»åŠ æ ¼å¼åŒ–ç›®æ ‡ end

# æ·»åŠ æ€§èƒ½æµ‹è¯•ç¨‹åºï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
if(EXISTS ${PROJECT_SOURCE_DIR}/kv_raft_performance_test.cpp)
  add_executable(kv_raft_performance_test kv_raft_performance_test.cpp src/raftClerk/clerk.cpp src/raftClerk/raftServerRpcUtil.cpp src/common/util.cpp src/common/compressor.cpp)
  target_link_libraries(kv_raft_performance_test skip_list_on_raft muduo_net muduo_base pthread dl boost_serialization protobuf ${COMPRESSION_LIBRARIES} spdlog::spdlog)
endif()

# åç¨‹å‹æµ‹å®¢æˆ·ç«¯ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
if(EXISTS ${PROJECT_SOURCE_DIR}/fiber_stress_test.cpp)
  add_executable(fiber_stress_test fiber_stress_test.cpp src/raftClerk/clerk.cpp src/raftClerk/raftServerRpcUtil.cpp src/common/util.cpp src/common/compressor.cpp)
  target_link_libraries(fiber_stress_test skip_list_on_raft muduo_net muduo_base pthread dl boost_serialization protobuf ${COMPRESSION_LIBRARIES} spdlog::spdlog)
endif()
