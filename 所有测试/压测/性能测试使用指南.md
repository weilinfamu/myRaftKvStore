# KV存储RAFT项目性能测试使用指南

## 问题分析

您正确地指出了问题：原来的`simple_stress_test.cpp`只是一个通用的CPU密集型测试，完全没有与实际的KV Raft存储项目关联。它只是测试了本机的计算能力，而没有测试分布式KV存储系统的实际性能。

## 解决方案

我已经创建了一套完整的性能测试工具，专门针对KV Raft存储项目：

### 1. 正确的性能测试程序

**`kv_raft_performance_test.cpp`** - 综合性能测试程序
- 使用项目的`Clerk`客户端与RAFT集群交互
- 支持多种测试类型：PUT、GET、混合操作、延迟测试
- 提供详细的性能统计信息
- 包含错误处理和异常捕获

### 2. 自动化测试脚本

**`perf_test_runner.sh`** - 自动化性能测试运行脚本
- 自动构建项目
- 运行性能测试
- 使用`perf`工具进行性能分析
- 生成火焰图和性能报告
- 支持多种配置选项

### 3. 现有的测试程序

**`stress_test.cpp`** - 现有的压力测试程序
- 已经正确使用了KV Raft客户端
- 支持长时间运行测试
- 提供基本的性能指标

## 使用方法

### 方法1：使用自动化脚本（推荐）

```bash
# 给脚本执行权限
chmod +x perf_test_runner.sh

# 运行完整性能测试
./perf_test_runner.sh -c test.conf -t 4 -o 1000 -T all

# 只测试PUT操作
./perf_test_runner.sh -t 8 -o 500 -T put

# 自定义输出目录
./perf_test_runner.sh -t 4 -o 2000 -T mixed -O my_results
```

### 方法2：手动运行测试程序

```bash
# 构建项目
cd build
make -j$(nproc)
cd ..

# 运行综合性能测试
./bin/kv_raft_performance_test test.conf 4 1000 all

# 只运行延迟测试
./bin/kv_raft_performance_test test.conf 1 1000 latency

# 运行现有的压力测试
./bin/stress_test test.conf 4 1000
```

### 方法3：直接编译运行

```bash
# 编译性能测试程序
g++ -std=c++17 -I src/raftClerk/include -I src/common/include -I src/rpc/include \
    -I src/raftCore/include -I src/raftRpcPro/include -I src/skipList/include \
    kv_raft_performance_test.cpp \
    src/raftClerk/clerk.cpp src/common/util.cpp \
    -o kv_perf_test -lpthread

# 运行测试
./kv_perf_test test.conf 4 1000 all
```

## 测试类型说明

### 1. PUT操作测试
- 测试写入性能
- 测量吞吐量和延迟
- 适合评估写入密集型场景

### 2. GET操作测试  
- 测试读取性能
- 测量读取延迟和吞吐量
- 适合评估读取密集型场景

### 3. 混合操作测试
- 70% PUT + 30% GET的混合负载
- 模拟真实世界的工作负载
- 测量系统在混合负载下的性能

### 4. 延迟测试
- 精确测量单个操作的延迟
- 提供P50、P95、P99延迟统计
- 适合评估系统响应时间

## 性能指标

### 关键性能指标
- **吞吐量**：操作数/秒 (ops/s)
- **延迟**：平均延迟、P50、P95、P99延迟
- **成功率**：成功操作的比例
- **资源使用**：CPU、内存、网络使用情况

### 性能分析工具
- **perf**：Linux性能分析工具
- **火焰图**：可视化性能瓶颈
- **性能报告**：详细的函数级性能分析

## 配置说明

### 测试配置文件 (`test.conf`)
```ini
node0ip=127.0.1.1
node0port=17830
node1ip=127.0.1.1  
node1port=17831
node2ip=127.0.1.1
node2port=17832
```

### 性能测试参数
- **线程数**：并发客户端数量（建议：2-16）
- **操作数**：每个线程执行的操作数量（建议：100-10000）
- **测试类型**：all、put、get、mixed、latency

## 最佳实践

### 1. 测试环境准备
```bash
# 确保RAFT集群正在运行
./bin/raftCoreRun -n 3 -f test.conf

# 检查集群状态
./bin/callerMain
```

### 2. 渐进式测试
```bash
# 从小规模开始
./perf_test_runner.sh -t 2 -o 100 -T put

# 逐步增加负载
./perf_test_runner.sh -t 4 -o 500 -T mixed

# 大规模压力测试
./perf_test_runner.sh -t 8 -o 2000 -T all
```

### 3. 性能分析
```bash
# 安装perf工具（Ubuntu）
sudo apt install linux-tools-common linux-tools-generic

# 查看火焰图
firefox perf_results/perf.svg

# 分析性能报告
less perf_results/perf_report.txt
```

## 问题排查

### 常见问题

1. **头文件找不到**
   - 确保使用正确的包含路径
   - 检查CMakeLists.txt中的include_directories配置

2. **连接失败**
   - 确保RAFT集群正在运行
   - 检查配置文件中的IP和端口

3. **性能测试失败**
   - 检查系统资源（内存、CPU）
   - 确保网络连接正常
   - 查看详细的错误日志

### 调试技巧

```bash
# 启用详细日志
export DEBUG=1

# 检查网络连接
netstat -tulpn | grep 1783

# 监控系统资源
top -p $(pgrep raftCoreRun)
```

## 总结

新的性能测试工具正确地测试了KV Raft存储项目的实际性能，包括：

- ✅ 与RAFT集群的实际交互
- ✅ 分布式系统的性能测试
- ✅ 详细的性能指标收集
- ✅ 专业的性能分析工具集成
- ✅ 错误处理和异常情况测试

这些工具可以帮助您全面评估KV Raft存储系统的性能表现，识别性能瓶颈，并进行优化。
