# Raft åˆ†å¸ƒå¼ KV å­˜å‚¨ç³»ç»Ÿ - å®Œæ•´é¢è¯•æŠ€æœ¯æŠ¥å‘Š

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**: åŸºäº Raft å…±è¯†ç®—æ³•çš„åˆ†å¸ƒå¼ KV å­˜å‚¨ç³»ç»Ÿ
- **æŠ€æœ¯æ ˆ**: C++ 17, Protobuf, Boost, Monsoonåç¨‹åº“, SkipList
- **æŠ¥å‘Šæ—¥æœŸ**: 2025å¹´10æœˆ31æ—¥
- **é€‚ç”¨åœºæ™¯**: æŠ€æœ¯é¢è¯•ã€ç³»ç»Ÿè®¾è®¡è®¨è®º

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ€»è§ˆ](#1-ç³»ç»Ÿæ¶æ„æ€»è§ˆ)
2. [å…±è¯†å±‚è¯¦è§£](#2-å…±è¯†å±‚è¯¦è§£-raftç®—æ³•)
3. [ç½‘ç»œåˆ†åŒºä¸å®¹é”™](#3-ç½‘ç»œåˆ†åŒºä¸å®¹é”™æœºåˆ¶)
4. [é€‰ä¸¾ç®—æ³•è¯¦è§£](#4-é€‰ä¸¾ç®—æ³•è¯¦è§£)
5. [è´Ÿè½½å‡è¡¡ä¸åˆ†ç‰‡](#5-è´Ÿè½½å‡è¡¡ä¸åˆ†ç‰‡æ–¹æ¡ˆ)
6. [æ€§èƒ½ä¼˜åŒ–æ€»è§ˆ](#6-æ€§èƒ½ä¼˜åŒ–æ€»è§ˆ)
7. [æœªæ¥ä¼˜åŒ–æ–¹å‘](#7-æœªæ¥ä¼˜åŒ–æ–¹å‘)
8. [é¢è¯•é—®ç­”é€ŸæŸ¥](#8-é¢è¯•é—®ç­”é€ŸæŸ¥)

---

## 1. ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Client Layer                             â”‚
â”‚                 (Clerk - å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“ RPC (Protobuf + åç¨‹åŒ–)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     RPC ç½‘ç»œå±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MprpcChannel â”‚  â”‚ConnectionPoolâ”‚  â”‚ Hook (åç¨‹send/recv)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     KV Server Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Get/PutAppend RPCæ¥å£                                     â”‚  â”‚
â”‚  â”‚  â†“                                                        â”‚  â”‚
â”‚  â”‚  è¯·æ±‚å»é‡ (lastRequestId)                                  â”‚  â”‚
â”‚  â”‚  â†“                                                        â”‚  â”‚
â”‚  â”‚  æäº¤åˆ° Raft (Start)                                       â”‚  â”‚
â”‚  â”‚  â†“                                                        â”‚  â”‚
â”‚  â”‚  ç­‰å¾…å…±è¯† (waitApplyCh)                                    â”‚  â”‚
â”‚  â”‚  â†“                                                        â”‚  â”‚
â”‚  â”‚  æ‰§è¡Œåˆ° SkipList                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Raft å…±è¯†å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Leaderé€‰ä¸¾    â”‚  â”‚æ—¥å¿—å¤åˆ¶       â”‚  â”‚å®‰å…¨æ€§ä¿è¯            â”‚  â”‚
â”‚  â”‚- é€‰ä¸¾è¶…æ—¶    â”‚  â”‚- AppendEntriesâ”‚  â”‚- Leaderå®Œæ•´æ€§       â”‚  â”‚
â”‚  â”‚- RequestVoteâ”‚  â”‚- å¿ƒè·³æœºåˆ¶     â”‚  â”‚- æ—¥å¿—åŒ¹é…           â”‚  â”‚
â”‚  â”‚- å¤šæ•°æ´¾æŠ•ç¥¨  â”‚  â”‚- å¹¶è¡Œå¤åˆ¶     â”‚  â”‚- çŠ¶æ€æœºå®‰å…¨         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å­˜å‚¨å±‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ SkipList       â”‚        â”‚ Persister (æŒä¹…åŒ–)            â”‚   â”‚
â”‚  â”‚ (å†…å­˜KVå­˜å‚¨)    â”‚        â”‚ - RaftçŠ¶æ€                    â”‚   â”‚
â”‚  â”‚                â”‚        â”‚ - æ—¥å¿—æ¡ç›®                    â”‚   â”‚
â”‚  â”‚                â”‚        â”‚ - Snapshot                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç»„ä»¶è¯´æ˜

| ç»„ä»¶ | èŒè´£ | å…³é”®æŠ€æœ¯ |
|------|------|---------|
| **Clerk** | å®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘ã€Leaderå‘ç° | ç¼“å­˜Leaderã€é‡è¯•æœºåˆ¶ |
| **KvServer** | KVæœåŠ¡å±‚ã€å»é‡ã€ç­‰å¾…å…±è¯† | SkipListã€waitApplyCh |
| **Raft** | å…±è¯†ç®—æ³•å®ç° | é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€å¿«ç…§ |
| **RPC** | ç½‘ç»œé€šä¿¡ | Protobufã€åç¨‹åŒ–ã€è¿æ¥æ±  |
| **Persister** | æŒä¹…åŒ–å­˜å‚¨ | åºåˆ—åŒ–ã€å¿«ç…§ |

---

## 2. å…±è¯†å±‚è¯¦è§£ (Raftç®—æ³•)

### 2.1 Raft æ ¸å¿ƒæ¦‚å¿µ

#### ä¸‰ç§è§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Leader (é¢†å¯¼è€…)                                          â”‚
â”‚  - æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚                                          â”‚
â”‚  - å¤åˆ¶æ—¥å¿—åˆ°æ‰€æœ‰ Follower                                 â”‚
â”‚  - å†³å®šæ—¥å¿—ä½•æ—¶å¯ä»¥å®‰å…¨æäº¤                                 â”‚
â”‚  - å‘é€å¿ƒè·³ç»´æŒæƒå¨                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†‘ é€‰ä¸¾                     â†“ å¿ƒè·³è¶…æ—¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Candidate (å€™é€‰äºº)                                       â”‚
â”‚  - å‘èµ·é€‰ä¸¾                                               â”‚
â”‚  - è¯·æ±‚å…¶ä»–èŠ‚ç‚¹æŠ•ç¥¨                                        â”‚
â”‚  - è·å¾—å¤šæ•°ç¥¨åæˆä¸º Leader                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ é€‰ä¸¾å¤±è´¥/å‘ç°æ›´é«˜term     â†‘ é€‰ä¸¾è¶…æ—¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Follower (è·Ÿéšè€…)                                        â”‚
â”‚  - å“åº” Leader çš„è¯·æ±‚                                     â”‚
â”‚  - å“åº” Candidate çš„æŠ•ç¥¨è¯·æ±‚                              â”‚
â”‚  - è½¬å‘å®¢æˆ·ç«¯è¯·æ±‚åˆ° Leader                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Term (ä»»æœŸ)

```
Term:  1         2         2         3         4
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€>
       Leader    Election  Leader    Leader    ...
                 (failed)

å…³é”®è§„åˆ™ï¼š
1. æ¯ä¸ª Term æœ€å¤šä¸€ä¸ª Leader
2. Term å•è°ƒé€’å¢
3. èŠ‚ç‚¹æ‹’ç»æ¥è‡ªæ—§ Term çš„è¯·æ±‚
4. èŠ‚ç‚¹å‘ç°æ›´é«˜ Term ç«‹å³è½¬ä¸º Follower
```

### 2.2 æ—¥å¿—å¤åˆ¶æœºåˆ¶

#### AppendEntries RPC

```cpp
// ä½ç½®ï¼šsrc/raftCore/raft.cpp:9-120
void Raft::AppendEntries1(const AppendEntriesArgs *args, 
                          AppendEntriesReply *reply) {
    std::lock_guard<std::mutex> locker(m_mtx);
    
    // 1. æ‹’ç»æ—§ Term çš„è¯·æ±‚
    if (args->term() < m_currentTerm) {
        reply->set_success(false);
        reply->set_term(m_currentTerm);
        return;
    }
    
    // 2. å‘ç°æ›´é«˜ Termï¼Œè½¬ä¸º Follower
    if (args->term() > m_currentTerm) {
        m_status = Follower;
        m_currentTerm = args->term();
        m_votedFor = -1;
        persist();
    }
    
    // 3. é‡ç½®é€‰ä¸¾è¶…æ—¶ï¼ˆæ”¶åˆ°æœ‰æ•ˆ Leader æ¶ˆæ¯ï¼‰
    m_lastResetElectionTime = std::chrono::steady_clock::now();
    
    // 4. æ—¥å¿—ä¸€è‡´æ€§æ£€æŸ¥
    int prevLogIndex = args->prevlogindex();
    int prevLogTerm = args->prevlogterm();
    
    if (!matchLog(prevLogIndex, prevLogTerm)) {
        reply->set_success(false);
        // å¿«é€Ÿå›é€€ä¼˜åŒ–
        // ...
        return;
    }
    
    // 5. è¿½åŠ æ–°æ—¥å¿—
    for (int i = 0; i < args->entries_size(); ++i) {
        auto log = args->entries(i);
        int logIndex = log.logindex();
        
        // æ£€æŸ¥å†²çª
        if (logIndex < m_logs.size() && 
            m_logs[logIndex].logterm() != log.logterm()) {
            // åˆ é™¤å†²çªçš„æ—¥å¿—åŠä¹‹åçš„æ‰€æœ‰æ—¥å¿—
            m_logs.erase(m_logs.begin() + logIndex, m_logs.end());
        }
        
        // è¿½åŠ æ–°æ—¥å¿—
        if (logIndex >= m_logs.size()) {
            m_logs.push_back(log);
        }
    }
    
    // 6. æ›´æ–° commitIndex
    if (args->leadercommit() > m_commitIndex) {
        m_commitIndex = std::min(args->leadercommit(), 
                                  getLastLogIndex());
    }
    
    reply->set_success(true);
    reply->set_term(m_currentTerm);
    persist();
}
```

#### Leader æ—¥å¿—å¤åˆ¶æµç¨‹

```
Leader æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚
  â†“
è¿½åŠ åˆ°æœ¬åœ°æ—¥å¿—
  â†“
å¹¶è¡Œå‘é€ AppendEntries åˆ°æ‰€æœ‰ Follower
  â†“
ç­‰å¾…å¤šæ•°æ´¾å“åº”
  â†“
æäº¤æ—¥å¿— (commitIndex++)
  â†“
åº”ç”¨åˆ°çŠ¶æ€æœº
  â†“
è¿”å›ç»“æœç»™å®¢æˆ·ç«¯
```

### 2.3 å®‰å…¨æ€§ä¿è¯

#### 5 å¤§å®‰å…¨æ€§ä¿è¯

1. **é€‰ä¸¾å®‰å…¨æ€§ (Election Safety)**
   - æ¯ä¸ª Term æœ€å¤šä¸€ä¸ª Leader
   - å®ç°ï¼šå¤šæ•°æ´¾æŠ•ç¥¨ + æ¯ä¸ªèŠ‚ç‚¹æ¯ä¸ª Term åªæŠ•ä¸€ç¥¨

2. **Leader é™„åŠ é™åˆ¶ (Leader Append-Only)**
   - Leader æ°¸ä¸è¦†ç›–æˆ–åˆ é™¤è‡ªå·±çš„æ—¥å¿—
   - åªèƒ½è¿½åŠ æ–°æ—¥å¿—

3. **æ—¥å¿—åŒ¹é… (Log Matching)**
   - å¦‚æœä¸¤ä¸ªæ—¥å¿—åœ¨ç›¸åŒ index å’Œ term ä¸Šæœ‰ç›¸åŒçš„æ¡ç›®
   - é‚£ä¹ˆå®ƒä»¬åœ¨è¯¥ index ä¹‹å‰çš„æ‰€æœ‰æ¡ç›®éƒ½ç›¸åŒ
   - å®ç°ï¼šprevLogIndex å’Œ prevLogTerm æ£€æŸ¥

4. **Leader å®Œæ•´æ€§ (Leader Completeness)**
   - å¦‚æœä¸€ä¸ªæ—¥å¿—æ¡ç›®åœ¨æŸä¸ª Term è¢«æäº¤
   - é‚£ä¹ˆè¿™ä¸ªæ¡ç›®å°†å‡ºç°åœ¨æ›´é«˜ Term çš„ Leader çš„æ—¥å¿—ä¸­
   - å®ç°ï¼šUpToDate æ£€æŸ¥ï¼ˆæŠ•ç¥¨é™åˆ¶ï¼‰

5. **çŠ¶æ€æœºå®‰å…¨æ€§ (State Machine Safety)**
   - å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å·²åº”ç”¨æŸä¸ªæ—¥å¿—æ¡ç›®åˆ°çŠ¶æ€æœº
   - é‚£ä¹ˆå…¶ä»–èŠ‚ç‚¹åœ¨ç›¸åŒ index ä¸ä¼šåº”ç”¨ä¸åŒçš„æ—¥å¿—
   - å®ç°ï¼šcommitIndex æœºåˆ¶

#### UpToDate æ£€æŸ¥

```cpp
// ä½ç½®ï¼šsrc/raftCore/raft.cpp:745-758
bool Raft::UpToDate(int index, int term) {
    int lastIndex = getLastLogIndex();
    int lastTerm = getLastLogTerm();
    
    // ä¼˜å…ˆæ¯”è¾ƒ Term
    if (term != lastTerm) {
        return term > lastTerm;
    }
    
    // Term ç›¸åŒï¼Œæ¯”è¾ƒ Index
    return index >= lastIndex;
}

// åœ¨ RequestVote ä¸­ä½¿ç”¨
if (!UpToDate(args->lastlogindex(), args->lastlogterm())) {
    // å€™é€‰äººçš„æ—¥å¿—ä¸å¤Ÿæ–°ï¼Œæ‹’ç»æŠ•ç¥¨
    reply->set_votegranted(false);
    return;
}
```

---

## 3. ç½‘ç»œåˆ†åŒºä¸å®¹é”™æœºåˆ¶

### 3.1 ç½‘ç»œåˆ†åŒºåœºæ™¯

#### åœºæ™¯1ï¼šç®€å•åˆ†åŒº (Split-Brain é˜²æŠ¤)

```
åŸå§‹é›†ç¾¤ï¼ˆ5èŠ‚ç‚¹ï¼‰:
  Node1(Leader) â† Node2 â† Node3 â† Node4 â† Node5

ç½‘ç»œåˆ†åŒºå‘ç”Ÿ:
  åˆ†åŒºAï¼ˆå¤šæ•°æ´¾ï¼‰: Node1(Leader), Node2, Node3
  åˆ†åŒºBï¼ˆå°‘æ•°æ´¾ï¼‰: Node4, Node5

è¿è¡Œè¿‡ç¨‹:
1. åˆ†åŒºA: 
   - Node1 ä»æ˜¯ Leader
   - å¯ä»¥ç»§ç»­æäº¤æ—¥å¿—ï¼ˆæœ‰å¤šæ•°æ´¾ï¼‰
   - å®¢æˆ·ç«¯è¯·æ±‚æ­£å¸¸å¤„ç† âœ…

2. åˆ†åŒºB:
   - Node4, Node5 æ£€æµ‹å¿ƒè·³è¶…æ—¶
   - å‘èµ·é€‰ä¸¾ï¼Œä½†æ— æ³•è·å¾—å¤šæ•°ç¥¨ï¼ˆåªæœ‰2ç¥¨ï¼‰
   - ä¸æ–­é‡è¯•é€‰ä¸¾ï¼Œä½†æ°¸è¿œæ— æ³•æˆä¸º Leader âŒ
   - å®¢æˆ·ç«¯è¯·æ±‚è¢«æ‹’ç»ï¼ˆ"æˆ‘ä¸æ˜¯Leader"ï¼‰

ç»“è®º: âœ… æ— è„‘è£‚é£é™©ï¼Œå¤šæ•°æ´¾ç»§ç»­å·¥ä½œ
```

#### åœºæ™¯2ï¼šå¤æ‚åˆ†åŒºï¼ˆ3ä¸ªåˆ†åŒºï¼‰

```
åŸå§‹é›†ç¾¤ï¼ˆ5èŠ‚ç‚¹ï¼‰:
  Node1(Leader) â† Node2 â† Node3 â† Node4 â† Node5
  Term = 10

ç½‘ç»œåˆ†åŒºå‘ç”Ÿï¼ˆä¸‰åˆ†åŒºï¼‰:
  åˆ†åŒºA: Node1(Leader), Node2  (2/5 å°‘æ•°)
  åˆ†åŒºB: Node3, Node4          (2/5 å°‘æ•°)
  åˆ†åŒºC: Node5                 (1/5 å°‘æ•°)

è¿è¡Œè¿‡ç¨‹:
1. åˆ†åŒºA (Node1, Node2):
   - Node1 ä»è®¤ä¸ºè‡ªå·±æ˜¯ Leader
   - ä½†æ— æ³•å¤åˆ¶åˆ°å¤šæ•°æ´¾
   - å®¢æˆ·ç«¯å†™å…¥ä¼šè¶…æ—¶å¤±è´¥ âŒ
   - å®é™…ä¸Šå·²ä¸å†æ˜¯æœ‰æ•ˆ Leader

2. åˆ†åŒºB (Node3, Node4):
   - é€‰ä¸¾è¶…æ—¶
   - å‘èµ·é€‰ä¸¾ï¼ŒTerm = 11
   - ä½†åªèƒ½è·å¾—2ç¥¨ï¼Œæ— æ³•æˆä¸º Leader
   - ä¸æ–­é‡è¯•é€‰ä¸¾ï¼ŒTerm æŒç»­å¢é•¿
   - Term = 11, 12, 13, ...

3. åˆ†åŒºC (Node5):
   - é€‰ä¸¾è¶…æ—¶
   - å‘èµ·é€‰ä¸¾ï¼Œä½†åªæœ‰1ç¥¨
   - æ°¸è¿œæ— æ³•æˆä¸º Leader

ç½‘ç»œæ¢å¤å:
1. Node1 (Term=10) å‘é€å¿ƒè·³
2. Node3 (Term=13) æ‹’ç»ï¼šTerm è¿‡ä½
3. Node1 å‘ç°æ›´é«˜ Termï¼Œè½¬ä¸º Follower
4. æœ€ç»ˆ Term=13 çš„èŠ‚ç‚¹æˆä¸ºæ–° Leader
5. æ—§ Leader çš„æœªæäº¤æ—¥å¿—è¢«è¦†ç›–

ç»“è®º: âœ… æ— è„‘è£‚ï¼Œä½†ä¼šæœ‰ Leader ç©ºçª—æœŸ
```

### 3.2 å¤šLeader é—®é¢˜çš„é¢„é˜²

#### Raft å¦‚ä½•é˜²æ­¢å¤š Leaderï¼Ÿ

**æœºåˆ¶1: å¤šæ•°æ´¾åŸåˆ™**
```
é›†ç¾¤å¤§å° N, éœ€è¦ > N/2 ç¥¨æ‰èƒ½æˆä¸º Leader

5èŠ‚ç‚¹é›†ç¾¤ï¼šéœ€è¦3ç¥¨
3èŠ‚ç‚¹é›†ç¾¤ï¼šéœ€è¦2ç¥¨

ä»»ä½•åˆ†åŒºï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªåˆ†åŒºèƒ½è¾¾åˆ°å¤šæ•°æ´¾
â†’ æœ€å¤šåªæœ‰ä¸€ä¸ª Leader âœ…
```

**æœºåˆ¶2: Term å•è°ƒé€’å¢**
```
æ—§ Leader (Term=10)
         â†“
ç½‘ç»œæ¢å¤
         â†“
é‡åˆ°æ–° Leader (Term=15)
         â†“
ç«‹å³è½¬ä¸º Follower
```

**æœºåˆ¶3: æ¯ä¸ª Term æ¯ä¸ªèŠ‚ç‚¹åªæŠ•ä¸€ç¥¨**
```cpp
// ä½ç½®ï¼šsrc/raftCore/raft.cpp:611-690
void Raft::RequestVote(const RequestVoteArgs* args, 
                       RequestVoteReply* reply) {
    std::lock_guard<std::mutex> locker(m_mtx);
    
    // æ‹’ç»æ—§ Term
    if (args->term() < m_currentTerm) {
        reply->set_votegranted(false);
        return;
    }
    
    // å‘ç°æ›´é«˜ Term
    if (args->term() > m_currentTerm) {
        m_status = Follower;
        m_currentTerm = args->term();
        m_votedFor = -1;  // é‡ç½®æŠ•ç¥¨
        persist();
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»æŠ•ç¥¨
    if (m_votedFor != -1 && m_votedFor != args->candidateid()) {
        reply->set_votegranted(false);  // å·²ç»æŠ•ç»™åˆ«äººäº†
        return;
    }
    
    // æ£€æŸ¥å€™é€‰äººæ—¥å¿—æ˜¯å¦è¶³å¤Ÿæ–°
    if (!UpToDate(args->lastlogindex(), args->lastlogterm())) {
        reply->set_votegranted(false);
        return;
    }
    
    // æŠ•ç¥¨
    m_votedFor = args->candidateid();
    m_lastResetElectionTime = std::chrono::steady_clock::now();
    reply->set_votegranted(true);
    persist();  // æŒä¹…åŒ–æŠ•ç¥¨å†³å®š
}
```

### 3.3 æ•…éšœæ£€æµ‹ä¸æ¢å¤

#### æ•…éšœç±»å‹ä¸å¤„ç†

| æ•…éšœç±»å‹ | æ£€æµ‹æ–¹å¼ | æ¢å¤æœºåˆ¶ | å½±å“ |
|---------|---------|---------|------|
| **èŠ‚ç‚¹å´©æºƒ** | å¿ƒè·³è¶…æ—¶ | é‡å¯åä»æŒä¹…åŒ–çŠ¶æ€æ¢å¤ | å°‘æ•°èŠ‚ç‚¹å´©æºƒä¸å½±å“æœåŠ¡ |
| **ç½‘ç»œåˆ†åŒº** | å¿ƒè·³è¶…æ—¶ | ç­‰å¾…ç½‘ç»œæ¢å¤ååŒæ­¥ | åªæœ‰å¤šæ•°æ´¾åˆ†åŒºå¯ç”¨ |
| **Leaderå´©æºƒ** | é€‰ä¸¾è¶…æ—¶ | è‡ªåŠ¨é€‰ä¸¾æ–°Leader | çŸ­æš‚ä¸å¯ç”¨(~300-500ms) |
| **æ¶ˆæ¯ä¸¢å¤±** | è¶…æ—¶é‡è¯• | AppendEntries å¹‚ç­‰æ€§ | è‡ªåŠ¨é‡è¯• |
| **æ¶ˆæ¯ä¹±åº** | prevLogæ£€æŸ¥ | æ‹’ç»ä¸åŒ¹é…çš„æ—¥å¿— | è‡ªåŠ¨ä¿®å¤ |

#### å¿«é€Ÿæ¢å¤ä¼˜åŒ–

```cpp
// æ—¥å¿—å†²çªå¿«é€Ÿå›é€€
// ä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªè¯•ï¼Œè€Œæ˜¯ç›´æ¥è·³åˆ°å†²çª Term çš„èµ·å§‹ä½ç½®

if (prevLogIndex >= m_logs.size()) {
    // æƒ…å†µ1: æ—¥å¿—å¤ªçŸ­
    reply->set_conflictindex(m_logs.size());
    reply->set_conflictterm(-1);
} else if (m_logs[prevLogIndex].term() != prevLogTerm) {
    // æƒ…å†µ2: Term å†²çª
    int conflictTerm = m_logs[prevLogIndex].term();
    // æ‰¾åˆ°è¯¥ Term çš„ç¬¬ä¸€æ¡æ—¥å¿—
    int firstIndex = prevLogIndex;
    while (firstIndex > 0 && 
           m_logs[firstIndex-1].term() == conflictTerm) {
        firstIndex--;
    }
    reply->set_conflictindex(firstIndex);
    reply->set_conflictterm(conflictTerm);
}

// Leader æ ¹æ®å†²çªä¿¡æ¯å¿«é€Ÿè°ƒæ•´ nextIndex
```

---

## 4. é€‰ä¸¾ç®—æ³•è¯¦è§£

### 4.1 é€‰ä¸¾è§¦å‘æ¡ä»¶

```cpp
// ä½ç½®ï¼šsrc/raftCore/raft.cpp:313-370
void Raft::electionTimeOutTicker() {
    while (true) {
        // åªæœ‰ Follower å’Œ Candidate æ‰æ£€æŸ¥é€‰ä¸¾è¶…æ—¶
        while (m_status == Leader) {
            usleep(HeartBeatTimeout * 1000);
        }
        
        // è®¡ç®—ç¡çœ æ—¶é—´ï¼ˆåˆ°è¶…æ—¶æ—¶é—´ç‚¹ï¼‰
        std::chrono::duration elapsed = now() - m_lastResetElectionTime;
        std::chrono::duration timeout = 
            std::chrono::milliseconds(ElectionTimeout) - elapsed;
        
        if (timeout.count() > 0) {
            usleep(timeout.count());
            continue;
        }
        
        // è¶…æ—¶äº†ï¼Œå‘èµ·é€‰ä¸¾
        doElection();
    }
}
```

### 4.2 é€‰ä¸¾è¿‡ç¨‹è¯¦è§£

#### å®Œæ•´é€‰ä¸¾æµç¨‹

```
Follower æ£€æµ‹åˆ°é€‰ä¸¾è¶…æ—¶
    â†“
è½¬ä¸º Candidate
    â†“
currentTerm++
    â†“
æŠ•ç¥¨ç»™è‡ªå·± (votedFor = self)
    â†“
æŒä¹…åŒ–çŠ¶æ€
    â†“
å¹¶è¡Œå‘æ‰€æœ‰èŠ‚ç‚¹å‘é€ RequestVote RPC
    â†“
ç­‰å¾…æŠ•ç¥¨ç»“æœï¼š
    â”œâ”€ è·å¾—å¤šæ•°ç¥¨ â†’ æˆä¸º Leader
    â”‚                 â””â”€ åˆå§‹åŒ– nextIndex[], matchIndex[]
    â”‚                 â””â”€ ç«‹å³å‘é€å¿ƒè·³ç¡®ç«‹æƒå¨
    â”‚
    â”œâ”€ æ”¶åˆ°æ›´é«˜ Term çš„ AppendEntries â†’ è½¬ä¸º Follower
    â”‚
    â”œâ”€ é€‰ä¸¾è¶…æ—¶ â†’ é‡æ–°å‘èµ·é€‰ä¸¾
    â”‚
    â””â”€ å…¶ä»– Candidate æˆä¸º Leader â†’ è½¬ä¸º Follower
```

#### ä»£ç å®ç°

```cpp
// ä½ç½®ï¼šsrc/raftCore/raft.cpp:216-287
void Raft::doElection() {
    std::lock_guard<std::mutex> lock(m_mtx);
    
    // 1. è½¬ä¸º Candidate
    m_status = Candidate;
    m_currentTerm++;
    m_votedFor = m_me;  // æŠ•ç¥¨ç»™è‡ªå·±
    persist();
    
    // é‡ç½®é€‰ä¸¾æ—¶é—´
    m_lastResetElectionTime = std::chrono::steady_clock::now();
    
    // 2. æ„é€  RequestVote å‚æ•°
    auto args = std::make_shared<RequestVoteArgs>();
    args->set_term(m_currentTerm);
    args->set_candidateid(m_me);
    args->set_lastlogindex(getLastLogIndex());
    args->set_lastlogterm(getLastLogTerm());
    
    // 3. æŠ•ç¥¨è®¡æ•°
    auto votedNum = std::make_shared<int>(1);  // è‡ªå·±å·²ç»æŠ•ç»™è‡ªå·±äº†
    
    // 4. å¹¶è¡Œå‘é€ RequestVote åˆ°æ‰€æœ‰èŠ‚ç‚¹
    for (int i = 0; i < m_peers.size(); ++i) {
        if (i == m_me) continue;
        
        // ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºåç¨‹å‘é€RPC
        m_ioManager->scheduler([this, i, args, votedNum]() {
            auto reply = std::make_shared<RequestVoteReply>();
            bool ok = sendRequestVote(i, args, reply, votedNum);
            
            if (!ok) return;
            
            std::lock_guard<std::mutex> lock(m_mtx);
            
            // æ£€æŸ¥çŠ¶æ€æ˜¯å¦å˜åŒ–
            if (m_status != Candidate || 
                args->term() != m_currentTerm) {
                return;  // å·²ç»ä¸æ˜¯å€™é€‰äººäº†æˆ–è€…Termå˜äº†
            }
            
            // å‘ç°æ›´é«˜çš„ Term
            if (reply->term() > m_currentTerm) {
                m_currentTerm = reply->term();
                m_status = Follower;
                m_votedFor = -1;
                persist();
                return;
            }
            
            // å¾—ç¥¨
            if (reply->votegranted()) {
                (*votedNum)++;
                
                // è·å¾—å¤šæ•°æ´¾æŠ•ç¥¨
                if (*votedNum > m_peers.size() / 2) {
                    // æˆä¸º Leader
                    m_status = Leader;
                    
                    // åˆå§‹åŒ– Leader çŠ¶æ€
                    for (int j = 0; j < m_peers.size(); ++j) {
                        m_nextIndex[j] = getLastLogIndex() + 1;
                        m_matchIndex[j] = 0;
                    }
                    
                    // ç«‹å³å‘é€å¿ƒè·³
                    doHeartBeat();
                }
            }
        });
    }
}
```

### 4.3 é€‰ä¸¾ä¼˜åŒ–ç­–ç•¥

#### ä¼˜åŒ–1: éšæœºé€‰ä¸¾è¶…æ—¶

```cpp
// é¿å…å¤šä¸ªèŠ‚ç‚¹åŒæ—¶è¶…æ—¶å¯¼è‡´é€‰ç¥¨åˆ†æ•£

const int ElectionTimeoutMin = 300;  // ms
const int ElectionTimeoutMax = 600;  // ms

int getRandomElectionTimeout() {
    std::random_device rd;
    std::mt19937 gen(rd());
    std::uniform_int_distribution<> dis(ElectionTimeoutMin, 
                                         ElectionTimeoutMax);
    return dis(gen);
}

// ä½¿ç”¨éšæœºè¶…æ—¶
electionTimeout = getRandomElectionTimeout();
```

**æ•ˆæœ**ï¼š
- é¿å…åŒæ—¶å‘èµ·é€‰ä¸¾
- å¿«é€Ÿæ”¶æ•›åˆ°ä¸€ä¸ª Leader
- å‡å°‘é€‰ä¸¾å†²çª

#### ä¼˜åŒ–2: Pre-Vote (é¢„æŠ•ç¥¨)

```
æ ‡å‡† Raft é—®é¢˜ï¼š
  èŠ‚ç‚¹ç½‘ç»œæ¢å¤åï¼ŒTerm è¿‡é«˜
  â†’ è§¦å‘ä¸å¿…è¦çš„é€‰ä¸¾
  â†’ æ‰“æ–­å½“å‰ Leader

Pre-Vote æ–¹æ¡ˆï¼š
1. å…ˆå‘é€ Pre-Vote è¯·æ±‚ï¼ˆä¸å¢åŠ  Termï¼‰
2. å¦‚æœèƒ½è·å¾—å¤šæ•°æ´¾åŒæ„
3. å†æ­£å¼å‘èµ·é€‰ä¸¾ï¼ˆå¢åŠ  Termï¼‰
4. å¦‚æœ Pre-Vote å¤±è´¥ï¼Œæ”¾å¼ƒé€‰ä¸¾

å¥½å¤„ï¼š
  - é¿å…æ— æ•ˆé€‰ä¸¾
  - å‡å°‘ Term è†¨èƒ€
  - æé«˜ç¨³å®šæ€§
```

#### ä¼˜åŒ–3: Leadership Transfer (ä¸»åŠ¨è½¬ç§»)

```cpp
// åœºæ™¯ï¼šéœ€è¦ä¼˜é›…å…³é—­ Leader
void Raft::TransferLeadership(int targetServer) {
    std::lock_guard<std::mutex> lock(m_mtx);
    
    if (m_status != Leader) return;
    
    // 1. åœæ­¢æ¥å—æ–°è¯·æ±‚
    // 2. ç¡®ä¿ç›®æ ‡èŠ‚ç‚¹æ—¥å¿—æœ€æ–°
    while (m_matchIndex[targetServer] < getLastLogIndex()) {
        sendAppendEntries(targetServer, ...);
    }
    
    // 3. å‘é€ TimeoutNow RPC
    // ç›®æ ‡èŠ‚ç‚¹ç«‹å³å‘èµ·é€‰ä¸¾
    sendTimeoutNow(targetServer);
    
    // 4. è½¬ä¸º Follower
    m_status = Follower;
}
```

---

## 5. è´Ÿè½½å‡è¡¡ä¸åˆ†ç‰‡æ–¹æ¡ˆ

### 5.1 å½“å‰æ¶æ„çš„è´Ÿè½½åˆ†é…

#### Client ä¾§è´Ÿè½½å‡è¡¡

```cpp
// ä½ç½®ï¼šsrc/raftClerk/clerk.cpp:50-145
class Clerk {
private:
    int m_leaderId;  // ç¼“å­˜çš„ Leader ID
    
public:
    std::string Get(std::string key) {
        int server = m_leaderId;
        
        while (true) {
            // å°è¯•å‘é€åˆ°ç¼“å­˜çš„ Leader
            auto reply = sendGetRPC(server, key);
            
            if (reply->err() == OK) {
                return reply->value();  // æˆåŠŸ
            }
            
            if (reply->err() == ErrWrongLeader) {
                // ä¸æ˜¯ Leaderï¼Œæ¢ä¸‹ä¸€ä¸ªèŠ‚ç‚¹é‡è¯•
                server = (server + 1) % m_servers.size();
                continue;
            }
            
            // è¶…æ—¶ï¼Œé‡è¯•
            usleep(100000);  // 100ms
        }
    }
};
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç®€å•è½®è¯¢ç­–ç•¥
- âœ… ç¼“å­˜ Leader å‡å°‘é‡è¯•
- âŒ æ‰€æœ‰è¯·æ±‚éƒ½æ‰“åˆ° Leaderï¼ˆå•ç‚¹ç“¶é¢ˆï¼‰
- âŒ æ— çœŸæ­£çš„è´Ÿè½½å‡è¡¡

#### å½“å‰ä¸ä½¿ç”¨é›ªèŠ±ç®—æ³•

**é—®é¢˜**ï¼šé¢è¯•å®˜é—®"æ˜¯å¦ç”¨é›ªèŠ±ç®—æ³•åˆ†é…è¯·æ±‚ï¼Ÿ"

**å›ç­”**ï¼š
```
å½“å‰ç³»ç»Ÿä¸ä½¿ç”¨é›ªèŠ±ç®—æ³•åšè´Ÿè½½åˆ†é…ï¼ŒåŸå› ï¼š

1. Raft æ¶æ„ç‰¹ç‚¹ï¼š
   - æ‰€æœ‰å†™è¯·æ±‚å¿…é¡»ç»è¿‡ Leader
   - ä¸€è‡´æ€§è¯»ä¹Ÿæ¨èèµ° Leaderï¼ˆé¿å…è¯»åˆ°æ—§æ•°æ®ï¼‰
   - æ— æ³•æ ¹æ® ID å“ˆå¸Œåˆ†é…ï¼ˆå¿…é¡»æ‰¾åˆ° Leaderï¼‰

2. é›ªèŠ±ç®—æ³•çš„ç”¨é€”ï¼š
   - ä¸»è¦ç”¨äºç”Ÿæˆåˆ†å¸ƒå¼å”¯ä¸€ID
   - ä¸æ˜¯è´Ÿè½½å‡è¡¡ç®—æ³•

3. å½“å‰è´Ÿè½½åˆ†é…ï¼š
   - Clerk ç¼“å­˜ Leader
   - è½®è¯¢æŸ¥æ‰¾ Leader
   - ç®€å•ä½†æœ‰æ•ˆ
```

### 5.2 åˆ†ç‰‡æ–¹æ¡ˆè®¾è®¡

#### ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ï¼Ÿ

```
å•é›†ç¾¤ç“¶é¢ˆï¼š
  - Leader å¤„ç†æ‰€æœ‰å†™è¯·æ±‚ï¼ˆå•ç‚¹ç“¶é¢ˆï¼‰
  - æ•°æ®é‡æœ‰é™ï¼ˆå•æœºå†…å­˜ï¼‰
  - QPS ä¸Šé™ï¼šçº¦ 50K-200K

åˆ†ç‰‡åï¼š
  - N ä¸ªåˆ†ç‰‡ â†’ N å€ååé‡
  - æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨
  - æ¨ªå‘æ‰©å±•èƒ½åŠ›
```

#### åˆ†ç‰‡æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Shard Controller                       â”‚
â”‚         (é…ç½®ç®¡ç†é›†ç¾¤ï¼Œä¹Ÿæ˜¯ Raft é›†ç¾¤)                    â”‚
â”‚                                                          â”‚
â”‚  Config 1: {Shard 0 â†’ Group 1, Shard 1 â†’ Group 2, ...} â”‚
â”‚  Config 2: {Shard 0 â†’ Group 3, Shard 1 â†’ Group 2, ...} â”‚
â”‚            (è´Ÿè´£åˆ†ç‰‡åˆ†é…ã€è¿ç§»åè°ƒ)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                  â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Group 1      â”‚  â”‚  Group 2      â”‚  â”‚  Group 3      â”‚
â”‚  (Rafté›†ç¾¤)   â”‚  â”‚  (Rafté›†ç¾¤)   â”‚  â”‚  (Rafté›†ç¾¤)   â”‚
â”‚               â”‚  â”‚               â”‚  â”‚               â”‚
â”‚  Shard 0, 3   â”‚  â”‚  Shard 1, 4   â”‚  â”‚  Shard 2, 5   â”‚
â”‚  KeyèŒƒå›´:     â”‚  â”‚  KeyèŒƒå›´:     â”‚  â”‚  KeyèŒƒå›´:     â”‚
â”‚  [a-f, p-u]   â”‚  â”‚  [g-l, v-z]   â”‚  â”‚  [m-o, A-Z]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åˆ†ç‰‡ç­–ç•¥

**æ–¹æ¡ˆ1: ä¸€è‡´æ€§å“ˆå¸Œ**

```cpp
class ConsistentHash {
private:
    std::map<uint64_t, int> ring;  // å“ˆå¸Œç¯
    int numShards;
    int virtualNodes = 150;  // æ¯ä¸ªåˆ†ç‰‡çš„è™šæ‹ŸèŠ‚ç‚¹æ•°
    
public:
    void addShard(int shardId) {
        for (int i = 0; i < virtualNodes; ++i) {
            uint64_t hash = hashFunc(shardId, i);
            ring[hash] = shardId;
        }
    }
    
    int getShardForKey(const std::string& key) {
        uint64_t hash = hashFunc(key);
        
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ª >= hash çš„èŠ‚ç‚¹
        auto it = ring.lower_bound(hash);
        if (it == ring.end()) {
            it = ring.begin();  // ç¯å½¢
        }
        
        return it->second;
    }
};
```

**ä¼˜ç‚¹**ï¼š
- âœ… åŠ¨æ€æ‰©ç¼©å®¹å½±å“å°ï¼ˆåªè¿ç§» 1/N æ•°æ®ï¼‰
- âœ… è´Ÿè½½å‡è¡¡è¾ƒå¥½

**ç¼ºç‚¹**ï¼š
- âŒ èŒƒå›´æŸ¥è¯¢ä¸å‹å¥½
- âŒ å®ç°å¤æ‚

**æ–¹æ¡ˆ2: å›ºå®šåˆ†ç‰‡æ•° + åŠ¨æ€åˆ†é…**

```cpp
// é…ç½®ç¤ºä¾‹
const int NUM_SHARDS = 10;  // å›ºå®šåˆ†ç‰‡æ•°

struct Config {
    int configNum;  // é…ç½®ç‰ˆæœ¬å·
    std::vector<int> shards;  // shards[i] = groupId
    std::map<int, std::vector<std::string>> groups;  // groupId -> servers
};

// Key åˆ° Shard çš„æ˜ å°„ï¼ˆæ°¸ä¸æ”¹å˜ï¼‰
int key2shard(const std::string& key) {
    return hash(key) % NUM_SHARDS;
}

// Shard åˆ° Group çš„æ˜ å°„ï¼ˆå¯åŠ¨æ€è°ƒæ•´ï¼‰
int shard2group(int shard, const Config& config) {
    return config.shards[shard];
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•æ˜ç¡®
- âœ… æ˜“äºç®¡ç†
- âœ… è´Ÿè½½å‡è¡¡å¯æ§

**ç¼ºç‚¹**ï¼š
- âŒ æ‰©å®¹éœ€è¦é‡æ–°åˆ†é…
- âŒ åˆ†ç‰‡æ•°å›ºå®š

#### åˆ†ç‰‡è¿ç§»åè®®

```
åœºæ™¯ï¼šShard 0 ä» Group 1 è¿ç§»åˆ° Group 2

1. Controller å‘å¸ƒæ–°é…ç½®
   Config 2: Shard 0 â†’ Group 2

2. Group 2 æ£€æµ‹åˆ°æ–°é…ç½®
   å‘ Group 1 è¯·æ±‚ Shard 0 æ•°æ®

3. Group 1 å‘é€å¿«ç…§
   åŒ…å« Shard 0 çš„æ‰€æœ‰ KV æ•°æ®

4. Group 2 æ¥æ”¶å¹¶å®‰è£…å¿«ç…§
   å¼€å§‹æœåŠ¡ Shard 0 çš„è¯·æ±‚

5. Group 1 åˆ é™¤ Shard 0 æ•°æ®
   ä¸å†æœåŠ¡ Shard 0

æŒ‘æˆ˜ï¼š
  - è¿ç§»æœŸé—´çš„ä¸€è‡´æ€§ï¼ˆéœ€è¦ç‰ˆæœ¬æ§åˆ¶ï¼‰
  - é¿å…æ•°æ®ä¸¢å¤±ï¼ˆç¡®è®¤å®‰è£…åå†åˆ é™¤ï¼‰
  - æ€§èƒ½å½±å“ï¼ˆåå°è¿ç§» vs åœæœè¿ç§»ï¼‰
```

### 5.3 è¯»ä¼˜åŒ–æ–¹æ¡ˆ

#### é—®é¢˜ï¼šå½“å‰æ‰€æœ‰è¯»éƒ½èµ° Leader

```
ç“¶é¢ˆåˆ†æï¼š
  - è¯»å¤šå†™å°‘åœºæ™¯ï¼ˆ95% è¯»ï¼Œ5% å†™ï¼‰
  - Leader æˆä¸ºç“¶é¢ˆ
  - Follower é—²ç½®
```

#### æ–¹æ¡ˆ1: Lease Readï¼ˆæ¨èï¼‰

```cpp
class Raft {
private:
    std::chrono::steady_clock::time_point m_leaseExpire;
    
public:
    bool Read(const std::string& key, std::string* value) {
        std::lock_guard<std::mutex> lock(m_mtx);
        
        if (m_status != Leader) {
            return false;  // ä¸æ˜¯ Leader
        }
        
        auto now = std::chrono::steady_clock::now();
        
        // æ£€æŸ¥ Lease æ˜¯å¦è¿˜æœ‰æ•ˆ
        if (now < m_leaseExpire) {
            // Lease æœ‰æ•ˆï¼Œç›´æ¥è¯»å–ï¼ˆæ— éœ€å…±è¯†ï¼‰
            *value = m_kvStore->get(key);
            return true;
        }
        
        // Lease è¿‡æœŸï¼Œéœ€è¦ç»­çº¦
        // å‘é€å¿ƒè·³ç¡®è®¤è‡ªå·±ä»æ˜¯ Leader
        if (renewLease()) {
            m_leaseExpire = now + std::chrono::milliseconds(100);
            *value = m_kvStore->get(key);
            return true;
        }
        
        return false;  // ä¸å†æ˜¯ Leader
    }
};
```

**ç‰¹ç‚¹**ï¼š
- âœ… Leader å¯ä»¥ç›´æ¥è¯»ï¼Œæ— éœ€å…±è¯†
- âœ… æ€§èƒ½æå‡ 10-100 å€
- âœ… ä»ä¿è¯çº¿æ€§ä¸€è‡´æ€§

**å®ç°å…³é”®**ï¼š
```
Lease æ—¶é—´ < é€‰ä¸¾è¶…æ—¶æ—¶é—´

ä¾‹å¦‚ï¼š
  ElectionTimeout = 300ms
  LeaseTime = 100ms
  
ä¿è¯ï¼šLeader åœ¨ Lease æœŸé—´ä¸ä¼šæœ‰æ–° Leader äº§ç”Ÿ
```

#### æ–¹æ¡ˆ2: Follower Read

```cpp
// Follower æä¾›è¯»æœåŠ¡ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰

class KvServer {
public:
    std::string Get(const std::string& key) {
        std::lock_guard<std::mutex> lock(m_mtx);
        
        // æ£€æŸ¥æœ¬åœ° commitIndex
        if (m_lastApplied >= m_commitIndex) {
            // æœ¬åœ°æ•°æ®å·²æ˜¯æœ€æ–°
            return m_skipList.get(key);
        }
        
        // ç­‰å¾…åŒæ­¥åˆ°æœ€æ–°
        waitForCommit(m_commitIndex);
        return m_skipList.get(key);
    }
};
```

**ç‰¹ç‚¹**ï¼š
- âœ… åˆ†æ•£è¯»å‹åŠ›
- âš ï¸ åªæä¾›æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå¯èƒ½è¯»åˆ°æ—§æ•°æ®ï¼‰
- âœ… é€‚åˆå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸ä¸¥æ ¼çš„åœºæ™¯

### 5.4 å®Œæ•´åˆ†ç‰‡ç³»ç»Ÿæ¶æ„

```cpp
// ==================== Shard Controller ====================
class ShardController {
private:
    std::unique_ptr<Raft> m_raft;  // ç”¨Raftç®¡ç†é…ç½®
    std::vector<Config> m_configs;  // é…ç½®å†å²
    
public:
    // åŠ å…¥æ–° Group
    void Join(const std::map<int, std::vector<std::string>>& groups) {
        // 1. æäº¤ Join æ“ä½œåˆ° Raft
        // 2. Apply åé‡æ–°å¹³è¡¡åˆ†ç‰‡
        // 3. ç”Ÿæˆæ–°é…ç½®
    }
    
    // ç¦»å¼€ Group
    void Leave(const std::vector<int>& gids) {
        // 1. æäº¤ Leave æ“ä½œåˆ° Raft
        // 2. é‡æ–°åˆ†é…ç¦»å¼€ Group çš„åˆ†ç‰‡
        // 3. ç”Ÿæˆæ–°é…ç½®
    }
    
    // å¹³è¡¡åˆ†ç‰‡
    Config rebalance() {
        // ç¡®ä¿æ¯ä¸ª Group çš„åˆ†ç‰‡æ•°ç›¸å·®ä¸è¶…è¿‡1
        // ...
    }
};

// ==================== Shard KV Server ====================
class ShardKvServer {
private:
    int m_gid;  // Group ID
    Config m_currentConfig;
    std::map<int, ShardData> m_shards;  // æœ¬ Group è´Ÿè´£çš„åˆ†ç‰‡
    
public:
    std::string Get(const std::string& key) {
        int shard = key2shard(key);
        
        // æ£€æŸ¥é…ç½®
        if (!responsibleForShard(shard)) {
            return ErrWrongGroup;
        }
        
        // æ£€æŸ¥åˆ†ç‰‡çŠ¶æ€
        if (m_shards[shard].status != Serving) {
            return ErrWrongGroup;  // æ­£åœ¨è¿ç§»
        }
        
        return m_shards[shard].kvStore.get(key);
    }
    
    // é…ç½®å˜æ›´
    void applyNewConfig(const Config& newConfig) {
        // 1. è¯†åˆ«éœ€è¦è¿å…¥çš„åˆ†ç‰‡
        for (int shard : needPullShards(newConfig)) {
            pullShard(shard);  // ä»å…¶ä»– Group æ‹‰å–
        }
        
        // 2. è¯†åˆ«éœ€è¦è¿å‡ºçš„åˆ†ç‰‡
        for (int shard : needPushShards(newConfig)) {
            m_shards[shard].status = Migrating;
        }
        
        // 3. æ›´æ–°é…ç½®
        m_currentConfig = newConfig;
    }
};
```

---

## 6. æ€§èƒ½ä¼˜åŒ–æ€»è§ˆ

### 6.1 å·²å®Œæˆä¼˜åŒ–

#### 1. RPC å±‚åç¨‹åŒ–

**æ”¹è¿›å‰**ï¼š
```cpp
// é˜»å¡å¼ I/O
int n = send(fd, data, len, 0);  // é˜»å¡æ•´ä¸ªçº¿ç¨‹
```

**æ”¹è¿›å**ï¼š
```cpp
// Hook æœºåˆ¶è‡ªåŠ¨å¼‚æ­¥åŒ–
int n = send(fd, data, len, 0);  // é˜»å¡åç¨‹ï¼Œçº¿ç¨‹ç»§ç»­è°ƒåº¦å…¶ä»–åç¨‹
```

**æ€§èƒ½æå‡**ï¼š
- ååé‡ï¼š+200-300% (3-4x)
- å»¶è¿Ÿï¼š-40% 
- å¹¶å‘æ•°ï¼š+900% (10x)

**æ–‡æ¡£**ï¼š`RPCå¢å¼ºåŠŸèƒ½æ€»è§ˆ.md` - ä»»åŠ¡ä¸€

#### 2. è¿æ¥æ± ä¼˜åŒ–

**æ”¹è¿›**ï¼š
- å¤ç”¨ TCP è¿æ¥
- å¥åº·æ£€æŸ¥æœºåˆ¶
- è‡ªåŠ¨é‡è¿

**æ€§èƒ½æå‡**ï¼š
- è¿æ¥å»ºç«‹å¼€é”€ï¼š-99%
- 1000æ¬¡è¯·æ±‚è€—æ—¶ï¼š15ç§’ â†’ 5ç§’ (3x)

**æ–‡æ¡£**ï¼š`RPCå¢å¼ºåŠŸèƒ½æ€»è§ˆ.md` - ä»»åŠ¡äºŒ

#### 3. åŠ¨æ€æ¥æ”¶ç¼“å†²åŒº

**æ”¹è¿›**ï¼š
- æŒ‰åè®®åˆ†æ­¥è¯»å–
- æ”¯æŒä»»æ„å¤§å°æ•°æ®

**æ€§èƒ½æå‡**ï¼š
- æ•°æ®æˆªæ–­ç‡ï¼š100% â†’ 0%
- å¤§æ•°æ®åç¨‹åˆ‡æ¢ï¼š-70%

**æ–‡æ¡£**ï¼š`RPCå¢å¼ºåŠŸèƒ½æ€»è§ˆ.md` - ä»»åŠ¡ä¸‰

#### 4. æ•°æ®å‹ç¼©ï¼ˆè®¾è®¡å®Œæˆï¼Œå¾…å®ç°ï¼‰

**æ–¹æ¡ˆ**ï¼š
- å¿«ç…§ï¼šZstd Level 3 (3.3x å‹ç¼©ç‡)
- æ—¥å¿—ï¼šLZ4 (2.2x å‹ç¼©ç‡)
- RPCï¼šLZ4 è‡ªé€‚åº”

**é¢„æœŸæå‡**ï¼š
- ç£ç›˜ç©ºé—´ï¼š-65%
- ç½‘ç»œå¸¦å®½ï¼š-70%
- å­˜å‚¨æˆæœ¬ï¼š-67%

**æ–‡æ¡£**ï¼š`docs/æ•°æ®å‹ç¼©ä¼˜åŒ–æ–¹æ¡ˆ.md`

### 6.2 å¾…ä¼˜åŒ–é¡¹ï¼ˆP0ä¼˜å…ˆçº§ï¼‰

#### 1. LockQueue é˜»å¡é—®é¢˜

**é—®é¢˜**ï¼š
```cpp
// å½“å‰å®ç°ä½¿ç”¨çº¿ç¨‹çº§æ¡ä»¶å˜é‡
T Pop() {
    std::unique_lock<std::mutex> lock(m_mutex);
    while (m_queue.empty()) {
        m_condvariable.wait(lock);  // âŒ é˜»å¡æ•´ä¸ªçº¿ç¨‹
    }
    // ...
}
```

**å½±å“**ï¼š
- é˜»å¡å·¥ä½œçº¿ç¨‹
- å…¶ä»–åç¨‹æ— æ³•è°ƒåº¦
- æ€§èƒ½ä¸‹é™ 50-200%

**è§£å†³æ–¹æ¡ˆ**ï¼š
```cpp
// ä½¿ç”¨åç¨‹å‹å¥½çš„è½®è¯¢ + usleep
T Pop() {
    while (true) {
        {
            std::lock_guard<std::mutex> lock(m_mutex);
            if (!m_queue.empty()) {
                T data = m_queue.front();
                m_queue.pop();
                return data;
            }
        }
        usleep(1000);  // ä¼šè¢« hook ä¸ºåç¨‹åˆ‡æ¢
    }
}
```

**é¢„æœŸæå‡**ï¼š+50-200%

**æ–‡æ¡£**ï¼š`æ€§èƒ½æå‡/æå‡.md` - P0-1

#### 2. SkipList é”ç²’åº¦è¿‡å¤§

**é—®é¢˜**ï¼š
```cpp
std::mutex _mtx;  // å…¨å±€é”ï¼Œæ‰€æœ‰æ“ä½œä¸²è¡ŒåŒ–

bool search_element(K key, V &value) {
    std::lock_guard<std::mutex> lock(_mtx);  // âŒ è¯»ä¹Ÿè¦ç‹¬å é”
    // ...
}
```

**å½±å“**ï¼š
- è¯»å†™ç›¸äº’é˜»å¡
- é«˜å¹¶å‘æ€§èƒ½å·®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```cpp
std::shared_mutex _mtx;  // è¯»å†™é”

bool search_element(K key, V &value) {
    std::shared_lock<std::shared_mutex> lock(_mtx);  // âœ… å¤šè¯»å¹¶å‘
    // ...
}

int insert_element(K key, V value) {
    std::unique_lock<std::shared_mutex> lock(_mtx);  // âœ… å†™æ“ä½œç‹¬å 
    // ...
}
```

**é¢„æœŸæå‡**ï¼šè¯»å¤šåœºæ™¯ +200-400%

**æ–‡æ¡£**ï¼š`æ€§èƒ½æå‡/æå‡.md` - P0-5

#### 3. Persister é¢‘ç¹ fsync

**é—®é¢˜**ï¼š
```cpp
// æ¯æ¬¡çŠ¶æ€å˜æ›´éƒ½ fsync
void persist() {
    write(data);
    fsync(fd);  // âŒ å¾ˆæ…¢ï¼ˆ1-10msï¼‰
}
```

**å½±å“**ï¼š
- QPS ä¸Šé™ï¼š100-1000
- I/O æˆä¸ºç“¶é¢ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```cpp
// æ‰¹é‡å†™å…¥ + å®šæœŸ fsync
void persist() {
    buffer.append(data);
    if (buffer.size() > threshold || timer_expired()) {
        write(buffer);
        fsync(fd);  // âœ… æ‰¹é‡åˆ·ç›˜
        buffer.clear();
    }
}
```

**é¢„æœŸæå‡**ï¼š+300-500%

**æ–‡æ¡£**ï¼š`æ€§èƒ½æå‡/è¯¦ç»†çš„é’ˆå¯¹æ€§Perfåˆ†ææŠ¥å‘Š.md` - 2.2èŠ‚

### 6.3 æ€§èƒ½æµ‹è¯•æ•°æ®

```
å½“å‰æ€§èƒ½ï¼ˆåŸºäºå®é™…æµ‹è¯•ï¼‰:
  CPUå‹åŠ›æµ‹è¯•ï¼š11,594 ops/s
  ä½å¹¶å‘ï¼š  5,000-10,000 QPS   âœ…
  ä¸­å¹¶å‘ï¼š 15,000-25,000 QPS   âœ…
  é«˜å¹¶å‘ï¼š 10,000-15,000 QPS   âš ï¸ï¼ˆé”ç«äº‰ï¼‰

ä¼˜åŒ–åé¢„æœŸï¼š
  ä½å¹¶å‘ï¼š 10,000-20,000 QPS   ğŸš€ (+100%)
  ä¸­å¹¶å‘ï¼š 40,000-80,000 QPS   ğŸš€ (+150-220%)
  é«˜å¹¶å‘ï¼š100,000-200,000 QPS  ğŸš€ğŸš€ (+500-1200%)
```

---

## 7. æœªæ¥ä¼˜åŒ–æ–¹å‘

### 7.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2ä¸ªæœˆï¼‰

#### 1. å®Œæˆæ‰€æœ‰ P0 ä¼˜åŒ–
- LockQueue åç¨‹åŒ–
- SkipList è¯»å†™é”
- æ‰¹é‡ fsync
- Raft é”ä¼˜åŒ–

**é¢„æœŸ**ï¼šæ€§èƒ½æå‡ 5-10å€

#### 2. å®ç°æ•°æ®å‹ç¼©
- Zstd å¿«ç…§å‹ç¼©
- LZ4 æ—¥å¿—å‹ç¼©
- RPC ä¼ è¾“å‹ç¼©

**é¢„æœŸ**ï¼šç£ç›˜/ç½‘ç»œå¼€é”€å‡å°‘ 60-70%

#### 3. å®ç° Lease Read
- Leader ç›´æ¥è¯»
- æ— éœ€å…±è¯†

**é¢„æœŸ**ï¼šè¯»æ€§èƒ½æå‡ 10-100å€

### 7.2 ä¸­æœŸä¼˜åŒ–ï¼ˆ3-6ä¸ªæœˆï¼‰

#### 1. åŸºç¡€åˆ†ç‰‡åŠŸèƒ½
- å®ç° Shard Controller
- å®ç° ShardKV Server
- æ”¯æŒåŠ¨æ€åˆ†ç‰‡

**é¢„æœŸ**ï¼šæ¨ªå‘æ‰©å±•èƒ½åŠ›

#### 2. å¼‚æ­¥å¿«ç…§
- åå°çº¿ç¨‹ç”Ÿæˆå¿«ç…§
- ä¸é˜»å¡å‰å°è¯·æ±‚

**é¢„æœŸ**ï¼šæ¶ˆé™¤å¿«ç…§å»¶è¿Ÿå°–åˆº

#### 3. å¹¶è¡Œæ—¥å¿—å¤åˆ¶
- Leader å¹¶è¡Œå‘é€åˆ°æ‰€æœ‰ Follower
- Follower å¹¶è¡Œåº”ç”¨æ—¥å¿—

**é¢„æœŸ**ï¼š+30-50% ååé‡

### 7.3 é•¿æœŸä¼˜åŒ–ï¼ˆ6-12ä¸ªæœˆï¼‰

#### 1. Multi-Raft
- æ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹çš„ Raft ç»„
- è¿›ä¸€æ­¥æå‡å¹¶è¡Œåº¦

**é¢„æœŸ**ï¼šN ä¸ªåˆ†ç‰‡ â†’ N å€ååé‡

#### 2. æ™ºèƒ½è·¯ç”±
- å®¢æˆ·ç«¯ç›´æ¥è¿æ¥æ­£ç¡®çš„åˆ†ç‰‡
- å‡å°‘è½¬å‘å¼€é”€

**é¢„æœŸ**ï¼š-50% ç½‘ç»œè·³è½¬

#### 3. æœºå™¨å­¦ä¹ è°ƒä¼˜
- è‡ªåŠ¨è°ƒæ•´å¿ƒè·³é—´éš”
- é¢„æµ‹é€‰ä¸¾æ—¶æœº
- æ™ºèƒ½è´Ÿè½½å‡è¡¡

**é¢„æœŸ**ï¼š+20-30% æ•´ä½“æ€§èƒ½

---

## 8. é¢è¯•é—®ç­”é€ŸæŸ¥

### 8.1 å…±è¯†å±‚é—®é¢˜

#### Q1: Raft å¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ

**A**: äº”å¤§å®‰å…¨æ€§ä¿è¯ + ä¸¤ä¸ªRPC
```
1. é€‰ä¸¾å®‰å…¨æ€§ï¼šæ¯ä¸ªTermæœ€å¤šä¸€ä¸ªLeader
2. Leaderé™„åŠ é™åˆ¶ï¼šLeaderæ°¸ä¸è¦†ç›–/åˆ é™¤æ—¥å¿—
3. æ—¥å¿—åŒ¹é…ï¼šç›¸åŒindex+termçš„æ—¥å¿—å‰é¢éƒ½ç›¸åŒ
4. Leaderå®Œæ•´æ€§ï¼šå·²æäº¤æ—¥å¿—å¿…å‡ºç°åœ¨æ–°Leader
5. çŠ¶æ€æœºå®‰å…¨æ€§ï¼šç›¸åŒindexä¸ä¼šåº”ç”¨ä¸åŒæ—¥å¿—

å®ç°æœºåˆ¶ï¼š
  - å¤šæ•°æ´¾æŠ•ç¥¨
  - UpToDateæ£€æŸ¥ï¼ˆæŠ•ç¥¨é™åˆ¶ï¼‰
  - prevLogä¸€è‡´æ€§æ£€æŸ¥
  - commitIndexæœºåˆ¶
```

#### Q2: ç½‘ç»œåˆ†åŒºåä¼šæœ‰å¤šä¸ª Leader å—ï¼Ÿ

**A**: ä¸ä¼šï¼ŒRaft é˜²æ­¢è„‘è£‚
```
æœºåˆ¶1: å¤šæ•°æ´¾åŸåˆ™
  - 5èŠ‚ç‚¹éœ€è¦3ç¥¨æˆä¸ºLeader
  - ä»»ä½•åˆ†åŒºæœ€å¤šä¸€ä¸ªæ»¡è¶³å¤šæ•°æ´¾
  - å°‘æ•°æ´¾åˆ†åŒºæ— æ³•é€‰å‡ºLeader

æœºåˆ¶2: Termå•è°ƒé€’å¢
  - æ—§Leaderé‡åˆ°é«˜Termç«‹å³è½¬Follower
  - ä¿è¯å”¯ä¸€Leader

å®ä¾‹ï¼š5èŠ‚ç‚¹åˆ†ä¸º(2,3)
  - 3èŠ‚ç‚¹åˆ†åŒºå¯ä»¥é€‰å‡ºLeader âœ…
  - 2èŠ‚ç‚¹åˆ†åŒºæ°¸è¿œé€‰ä¸å‡ºLeader âŒ
```

#### Q3: å¦‚ä½•é€‰ä¸¾æœ€åˆé€‚çš„ Leaderï¼Ÿ

**A**: UpToDate æ£€æŸ¥ + éšæœºè¶…æ—¶
```
1. æ—¥å¿—æœ€æ–°çš„èŠ‚ç‚¹ä¼˜å…ˆï¼š
   bool UpToDate(int index, int term) {
       // ä¼˜å…ˆæ¯”è¾ƒ Termï¼Œå†æ¯”è¾ƒ Index
       if (term != lastTerm) return term > lastTerm;
       return index >= lastIndex;
   }

2. éšæœºé€‰ä¸¾è¶…æ—¶é¿å…å†²çªï¼š
   ElectionTimeout = random(300ms, 600ms)
   â†’ æœ€å…ˆè¶…æ—¶çš„èŠ‚ç‚¹å…ˆå‘èµ·é€‰ä¸¾
   â†’ é€šå¸¸èƒ½å¿«é€Ÿé€‰å‡ºLeader

3. æŠ•ç¥¨é™åˆ¶ï¼š
   - å€™é€‰äººæ—¥å¿—ä¸å¤Ÿæ–° â†’ æ‹’ç»æŠ•ç¥¨
   - ä¿è¯é€‰å‡ºçš„Leaderæ‹¥æœ‰æ‰€æœ‰å·²æäº¤æ—¥å¿—
```

### 8.2 ç½‘ç»œä¸è´Ÿè½½é—®é¢˜

#### Q4: RPC åˆ° KvServer å¦‚ä½•åˆ†é…è¯·æ±‚ï¼Ÿ

**A**: å½“å‰ç®€å•è½®è¯¢ï¼Œä¸ä½¿ç”¨é›ªèŠ±ç®—æ³•
```
å½“å‰å®ç°ï¼š
  1. Clerk ç¼“å­˜ Leader ID
  2. è¯·æ±‚å‘é€åˆ°ç¼“å­˜çš„ Leader
  3. å¦‚æœé”™è¯¯ï¼Œè½®è¯¢ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
  4. æ‰¾åˆ° Leader åæ›´æ–°ç¼“å­˜

ä¸ºä»€ä¹ˆä¸ç”¨é›ªèŠ±ç®—æ³•ï¼Ÿ
  - é›ªèŠ±ç®—æ³•ç”¨äºç”Ÿæˆåˆ†å¸ƒå¼å”¯ä¸€ID
  - Raftå†™è¯·æ±‚å¿…é¡»ç»è¿‡Leaderï¼ˆæ— æ³•å“ˆå¸Œåˆ†é…ï¼‰
  - ä¸€è‡´æ€§è¯»ä¹Ÿæ¨èèµ°Leader

æœªæ¥ä¼˜åŒ–ï¼š
  - Lease Readï¼šLeaderç›´æ¥è¯»
  - Follower Readï¼šæœ€ç»ˆä¸€è‡´æ€§è¯»
  - åˆ†ç‰‡ï¼šå¤šä¸ªRaftç»„åˆ†æ‹…è´Ÿè½½
```

#### Q5: å¦‚ä½•å‡å°‘è´Ÿè½½/æå‡ååé‡ï¼Ÿ

**A**: å¤šå±‚æ¬¡ä¼˜åŒ–
```
å·²å®Œæˆï¼š
  1. åç¨‹åŒ–ï¼šå•çº¿ç¨‹å¤„ç†æ•°åƒè¯·æ±‚
  2. è¿æ¥æ± ï¼šå‡å°‘TCPæ¡æ‰‹å¼€é”€
  3. åŠ¨æ€ç¼“å†²åŒºï¼šé¿å…æ•°æ®æˆªæ–­

å¾…å®Œæˆï¼ˆP0ï¼‰ï¼š
  4. è¯»å†™é”ï¼šè¯»å¹¶å‘æå‡10-20å€
  5. æ‰¹é‡fsyncï¼šI/Oæ€§èƒ½æå‡3-5å€
  6. é”ä¼˜åŒ–ï¼šé«˜å¹¶å‘æå‡5-10å€

æœªæ¥æ–¹å‘ï¼š
  7. Lease Readï¼šè¯»æ€§èƒ½10-100å€
  8. åˆ†ç‰‡ï¼šæ¨ªå‘æ‰©å±•Nå€
  9. Multi-Raftï¼šè¿›ä¸€æ­¥å¹¶è¡ŒåŒ–
```

### 8.3 åˆ†ç‰‡ä¸æ‰©å±•é—®é¢˜

#### Q6: å¦‚ä½•å®ç°åˆ†ç‰‡ï¼Ÿ

**A**: ä¸‰å±‚æ¶æ„è®¾è®¡
```
æ¶æ„ï¼š
  Shard Controller (é…ç½®ç®¡ç†)
     â†“
  Group 1, Group 2, ... (å¤šä¸ªRafté›†ç¾¤)
     â†“
  æ¯ä¸ªGroupè´Ÿè´£è‹¥å¹²Shard

åˆ†ç‰‡ç­–ç•¥ï¼š
  1. å›ºå®šåˆ†ç‰‡æ•°ï¼ˆå¦‚10ä¸ªï¼‰
  2. Keyåˆ°Shardï¼šhash(key) % 10
  3. Shardåˆ°Groupï¼šåŠ¨æ€é…ç½®
  4. é…ç½®å˜æ›´è§¦å‘åˆ†ç‰‡è¿ç§»

ä¼˜åŠ¿ï¼š
  - Nä¸ªGroup â†’ Nå€ååé‡
  - æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨
  - æ¨ªå‘æ‰©å±•èƒ½åŠ›
```

#### Q7: åˆ†ç‰‡è¿ç§»å¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ

**A**: ä¸¤é˜¶æ®µåè®® + ç‰ˆæœ¬æ§åˆ¶
```
è¿ç§»æµç¨‹ï¼ˆShard 0: Group 1 â†’ Group 2ï¼‰:

1. Controllerå‘å¸ƒæ–°é…ç½® (Config N)
   Shard 0 â†’ Group 2

2. Group 2æ£€æµ‹é…ç½®å˜æ›´
   å‘Group 1è¯·æ±‚Shard 0æ•°æ®
   (æºå¸¦Config Nç‰ˆæœ¬å·)

3. Group 1å‘é€å¿«ç…§
   åŒ…å«æ‰€æœ‰Shard 0çš„KVæ•°æ®
   åŒæ—¶è®°å½•è¿ç§»ä¸­çŠ¶æ€

4. Group 2æ¥æ”¶å¹¶å®‰è£…å¿«ç…§
   å¼€å§‹æœåŠ¡Shard 0è¯·æ±‚

5. Group 2ç¡®è®¤å®Œæˆ
   Group 1åˆ é™¤Shard 0æ•°æ®

å…³é”®ç‚¹ï¼š
  - ç‰ˆæœ¬å·ç¡®ä¿è¯·æ±‚å‘åˆ°æ­£ç¡®Group
  - è¿ç§»æœŸé—´æ—§Groupä»æœåŠ¡
  - æ–°Groupç¡®è®¤åæ—§Groupæ‰åˆ é™¤
```

### 8.4 æ€§èƒ½ä¸ä¼˜åŒ–é—®é¢˜

#### Q8: ç³»ç»Ÿå½“å‰æ€§èƒ½å¦‚ä½•ï¼Ÿç“¶é¢ˆåœ¨å“ªï¼Ÿ

**A**: ä¸­ç­‰å¹¶å‘è‰¯å¥½ï¼Œé«˜å¹¶å‘æœ‰ç“¶é¢ˆ
```
å®æµ‹æ€§èƒ½ï¼š
  ä½å¹¶å‘ï¼ˆ< 100 QPSï¼‰ï¼šâœ… ä¼˜ç§€
  ä¸­å¹¶å‘ï¼ˆ100-1000 QPSï¼‰ï¼šâœ… è‰¯å¥½
  é«˜å¹¶å‘ï¼ˆ> 1000 QPSï¼‰ï¼šâš ï¸ é”ç«äº‰

å…·ä½“æ•°æ®ï¼š
  - CPUå‹åŠ›æµ‹è¯•ï¼š11,594 ops/s
  - ç½‘ç»œRPCï¼š15,000-25,000 QPS

ç“¶é¢ˆï¼š
  1. SkipListå…¨å±€é”ï¼ˆP0ï¼‰
  2. Raft m_mtxé”ç«äº‰ï¼ˆP0ï¼‰
  3. é¢‘ç¹fsyncï¼ˆP0ï¼‰
  4. LockQueueé˜»å¡ï¼ˆP0ï¼‰

ä¼˜åŒ–åé¢„æœŸï¼š
  - 100,000-200,000 QPS (5-10xæå‡)
```

#### Q9: ä¸ºä»€ä¹ˆé€‰æ‹© LZ4 å’Œ Zstd å‹ç¼©ï¼Ÿ

**A**: æ€§èƒ½å’Œå‹ç¼©ç‡çš„å¹³è¡¡
```
ç®—æ³•å¯¹æ¯”ï¼š
  LZ4:    550 MB/s å‹ç¼©, 2.2xå‹ç¼©ç‡, æé€Ÿ
  Zstd-3: 330 MB/s å‹ç¼©, 3.3xå‹ç¼©ç‡, å¹³è¡¡
  Gzip:   25 MB/s å‹ç¼©,  3.5xå‹ç¼©ç‡, å¤ªæ…¢

é€‰æ‹©ç†ç”±ï¼š
  1. LZ4ç”¨äºæ—¥å¿—/RPCï¼š
     - å»¶è¿Ÿæ•æ„Ÿ
     - éœ€è¦æé€Ÿå‹ç¼©/è§£å‹
     - 2.2xå·²è¶³å¤Ÿ

  2. Zstd-3ç”¨äºå¿«ç…§ï¼š
     - æ•°æ®é‡å¤§
     - å¯¹å»¶è¿Ÿä¸å¤ªæ•æ„Ÿ
     - éœ€è¦æ›´é«˜å‹ç¼©ç‡

ä¸ºä»€ä¹ˆä¸ç”¨Huffman/MTFï¼Ÿ
  - å•ç‹¬ä½¿ç”¨å‹ç¼©ç‡ä½ï¼ˆ~1.5xï¼‰
  - ç°ä»£LZç®—æ³•å·²å†…ç½®
  - æ€§ä»·æ¯”ä½
```

### 8.5 ä¸€å¥è¯å›ç­”é€ŸæŸ¥

| é—®é¢˜ | ä¸€å¥è¯å›ç­” |
|------|-----------|
| **Raftå¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ** | äº”å¤§å®‰å…¨æ€§ä¿è¯ï¼šé€‰ä¸¾å®‰å…¨ã€Leaderé™„åŠ é™åˆ¶ã€æ—¥å¿—åŒ¹é…ã€Leaderå®Œæ•´æ€§ã€çŠ¶æ€æœºå®‰å…¨ |
| **ä¼šä¸ä¼šæœ‰å¤šLeaderï¼Ÿ** | ä¸ä¼šï¼Œå¤šæ•°æ´¾æŠ•ç¥¨ç¡®ä¿æ¯ä¸ªTermæœ€å¤šä¸€ä¸ªLeader |
| **å¦‚ä½•é€‰ä¸¾æœ€åˆé€‚Leaderï¼Ÿ** | UpToDateæ£€æŸ¥ä¿è¯é€‰å‡ºæ—¥å¿—æœ€æ–°çš„èŠ‚ç‚¹ + éšæœºè¶…æ—¶é¿å…å†²çª |
| **å¦‚ä½•åˆ†é…è¯·æ±‚åˆ°èŠ‚ç‚¹ï¼Ÿ** | Clerkç¼“å­˜Leaderå¹¶è½®è¯¢ï¼Œä¸ç”¨é›ªèŠ±ç®—æ³•ï¼ˆRaftå¿…é¡»èµ°Leaderï¼‰ |
| **å¦‚ä½•å‡å°‘è´Ÿè·ï¼Ÿ** | å·²å®Œæˆåç¨‹åŒ–+è¿æ¥æ± ï¼Œå¾…åšè¯»å†™é”+æ‰¹é‡fsync+åˆ†ç‰‡ |
| **å¦‚ä½•åˆ†ç‰‡ï¼Ÿ** | å›ºå®šåˆ†ç‰‡æ•°ï¼ŒKeyå“ˆå¸Œåˆ°Shardï¼ŒShardåŠ¨æ€åˆ†é…åˆ°Group |
| **åˆ†ç‰‡è¿ç§»å¦‚ä½•ä¸€è‡´ï¼Ÿ** | ä¸¤é˜¶æ®µåè®®+ç‰ˆæœ¬æ§åˆ¶ï¼Œæ–°Groupç¡®è®¤åæ—§Groupæ‰åˆ é™¤ |
| **å½“å‰æ€§èƒ½ç“¶é¢ˆï¼Ÿ** | é«˜å¹¶å‘ä¸‹SkipListå’ŒRaftçš„é”ç«äº‰ + é¢‘ç¹fsync |
| **ä¸ºä»€ä¹ˆç”¨LZ4/Zstdï¼Ÿ** | LZ4æé€Ÿé€‚åˆæ—¥å¿—/RPCï¼ŒZstdå¹³è¡¡é€‚åˆå¿«ç…§ï¼Œæ¯”Gzipå¿«13å€ |

---

## 9. æ–‡æ¡£å¯¼èˆª

### 9.1 æ ¸å¿ƒæ–‡æ¡£

| æ–‡æ¡£ | å†…å®¹ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **æœ¬æ–‡æ¡£** | å®Œæ•´æŠ€æœ¯æŠ¥å‘Š | é¢è¯•å‡†å¤‡ã€ç³»ç»Ÿè®¾è®¡è®¨è®º |
| **RPCå¢å¼ºåŠŸèƒ½æ€»è§ˆ.md** | RPCä¼˜åŒ–+æ•°æ®å‹ç¼© | ç½‘ç»œå±‚é¢è¯•é—®é¢˜ |
| **æ€§èƒ½æå‡/æå‡.md** | 32å¤„æ€§èƒ½ä¼˜åŒ–ç‚¹ | æ€§èƒ½ä¼˜åŒ–é—®é¢˜ |
| **æ€§èƒ½æå‡/è¯¦ç»†çš„é’ˆå¯¹æ€§Perfåˆ†ææŠ¥å‘Š.md** | åˆ†å±‚æ€§èƒ½åˆ†æ | æ·±å…¥æ€§èƒ½é—®é¢˜ |
| **docs/æ•°æ®å‹ç¼©ä¼˜åŒ–æ–¹æ¡ˆ.md** | å‹ç¼©ç®—æ³•è¯¦è§£ | å‹ç¼©ç›¸å…³é—®é¢˜ |
| **docs/å‹ç¼©ä¼˜åŒ–å¿«é€Ÿå‚è€ƒ.md** | å‹ç¼©é€ŸæŸ¥å¡ | å¿«é€ŸæŸ¥çœ‹æ•°æ® |

### 9.2 ä»£ç ä½ç½®é€ŸæŸ¥

| åŠŸèƒ½ | æ–‡ä»¶ä½ç½® | å…³é”®å‡½æ•° |
|------|---------|---------|
| **Raftæ ¸å¿ƒ** | `src/raftCore/raft.cpp` | AppendEntries1, RequestVote, doElection |
| **é€‰ä¸¾ç®—æ³•** | `src/raftCore/raft.cpp:313-370` | electionTimeOutTicker, doElection |
| **æ—¥å¿—å¤åˆ¶** | `src/raftCore/raft.cpp:9-120` | AppendEntries1, sendAppendEntries |
| **KVæœåŠ¡** | `src/raftCore/kvServer.cpp` | Get, PutAppend |
| **å®¢æˆ·ç«¯** | `src/raftClerk/clerk.cpp` | Get, Put, Append |
| **RPCç½‘ç»œ** | `src/rpc/mprpcchannel.cpp` | CallMethod |
| **è¿æ¥æ± ** | `src/rpc/connectionpool.cpp` | GetConnection, ReturnConnection |
| **SkipList** | `src/skipList/include/skipList.h` | insert_element, search_element |

---

## 10. æ€»ç»“

### 10.1 æ ¸å¿ƒäº®ç‚¹

1. **å®Œæ•´çš„ Raft å®ç°**
   - é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€å¿«ç…§å…¨éƒ¨å®ç°
   - é€šè¿‡å®‰å…¨æ€§æµ‹è¯•

2. **é«˜æ€§èƒ½ç½‘ç»œå±‚**
   - åç¨‹åŒ– RPC (+3å€ååé‡)
   - è¿æ¥æ±  (+3å€æ€§èƒ½)
   - åŠ¨æ€ç¼“å†²åŒº (100%å¯é æ€§)

3. **ç³»ç»ŸåŒ–æ€§èƒ½ä¼˜åŒ–**
   - è¯†åˆ«32å¤„ä¼˜åŒ–ç‚¹
   - é¢„æœŸ5-10å€æ€§èƒ½æå‡
   - æ•°æ®å‹ç¼©èŠ‚çœ65%ç©ºé—´

4. **å¯æ‰©å±•æ¶æ„**
   - æ¸…æ™°çš„åˆ†å±‚è®¾è®¡
   - åˆ†ç‰‡æ–¹æ¡ˆè®¾è®¡å®Œæ•´
   - æ¨ªå‘æ‰©å±•èƒ½åŠ›

### 10.2 å¾…å®Œæˆå·¥ä½œ

**P0ä¼˜å…ˆçº§ï¼ˆç«‹å³ï¼‰**ï¼š
- [ ] LockQueue åç¨‹åŒ–
- [ ] SkipList è¯»å†™é”
- [ ] æ‰¹é‡ fsync
- [ ] Raft é”ä¼˜åŒ–

**P1ä¼˜å…ˆçº§ï¼ˆçŸ­æœŸï¼‰**ï¼š
- [ ] æ•°æ®å‹ç¼©å®ç°
- [ ] Lease Read
- [ ] Follower Read

**P2ä¼˜å…ˆçº§ï¼ˆä¸­æœŸï¼‰**ï¼š
- [ ] åˆ†ç‰‡åŠŸèƒ½å®ç°
- [ ] å¼‚æ­¥å¿«ç…§
- [ ] Multi-Raft

### 10.3 å…³é”®æ•°å­—è®°å¿†ï¼ˆé¢è¯•å¿…èƒŒï¼‰

```
æ€§èƒ½æ•°æ®ï¼š
  - å½“å‰QPSï¼š15,000-25,000
  - ä¼˜åŒ–åQPSï¼š100,000-200,000
  - æå‡å€æ•°ï¼š5-10å€

å‹ç¼©æ•°æ®ï¼š
  - Zstdå¿«ç…§ï¼š3.3xå‹ç¼©ç‡
  - LZ4æ—¥å¿—ï¼š2.2xå‹ç¼©ç‡
  - ç©ºé—´èŠ‚çœï¼š65%

ç½‘ç»œæ•°æ®ï¼š
  - åç¨‹æå‡ï¼š3-4å€
  - è¿æ¥æ± æå‡ï¼š3å€
  - å¸¦å®½èŠ‚çœï¼š70%

åˆ†ç‰‡æ•°æ®ï¼š
  - Nä¸ªåˆ†ç‰‡ï¼šNå€ååé‡
  - Lease Readï¼š10-100å€è¯»æ€§èƒ½
```

---

**é¢è¯•å‡†å¤‡å®Œæˆï¼ç¥ä½ é¢è¯•æˆåŠŸï¼** ğŸš€

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ31æ—¥  
**ç‰ˆæœ¬**: v1.0 - å®Œæ•´ç‰ˆ

