# ğŸ‰ æ¶æ„é‡æ„å®Œæˆè¯´æ˜

## ğŸ“‹ å¿«é€Ÿå¯¼èˆª

- **è®¾è®¡æ–‡æ¡£**: [æ¶æ„è§£è€¦ä¼˜åŒ–æ–¹æ¡ˆ.md](./æ¶æ„è§£è€¦ä¼˜åŒ–æ–¹æ¡ˆ.md)
- **å®ŒæˆæŠ¥å‘Š**: [æ¶æ„é‡æ„å®ŒæˆæŠ¥å‘Š.md](./æ¶æ„é‡æ„å®ŒæˆæŠ¥å‘Š.md)
- **éªŒè¯æŒ‡å—**: [é‡æ„éªŒè¯æŒ‡å—.md](./é‡æ„éªŒè¯æŒ‡å—.md)

---

## âœ… é‡æ„çŠ¶æ€

| é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è®¾è®¡é˜¶æ®µ | âœ… å®Œæˆ | å·²è¾“å‡ºè¯¦ç»†è®¾è®¡æ–‡æ¡£ |
| æ¥å£å®šä¹‰ | âœ… å®Œæˆ | 6ä¸ªæ ¸å¿ƒæ¥å£å·²å®šä¹‰ |
| é€‚é…å™¨å®ç° | âœ… å®Œæˆ | 5ä¸ªé€‚é…å™¨å·²å®ç° |
| ä¸šåŠ¡é‡æ„ | âœ… å®Œæˆ | KvStateMachineå·²åˆ›å»º |
| å®¢æˆ·ç«¯é‡æ„ | âœ… å®Œæˆ | è´Ÿè½½å‡è¡¡æ¥å£å·²é›†æˆ |
| ç¼–è¯‘éªŒè¯ | âœ… é€šè¿‡ | makeç¼–è¯‘æˆåŠŸ |
| ç¨‹åºéªŒè¯ | âœ… é€šè¿‡ | å¯æ‰§è¡Œæ–‡ä»¶æ­£å¸¸è¿è¡Œ |
| é›†ç¾¤æµ‹è¯• | â³ å¾…æ‰§è¡Œ | éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æµ‹è¯• |

---

## ğŸ¯ é‡æ„æˆæœ

### æ ¸å¿ƒæ”¹è¿›

1. **å­˜å‚¨å±‚è§£è€¦** âœ…
   - åˆ›å»º `IStorageEngine` æ¥å£
   - SkipListé€šè¿‡é€‚é…å™¨åŒ…è£…
   - å¯ä»¥è½»æ¾åˆ‡æ¢ä¸ºLsmTreeã€RocksDBç­‰

2. **æŒä¹…åŒ–å±‚è§£è€¦** âœ…
   - åˆ›å»º `IPersistenceLayer` æ¥å£
   - Persisteré€šè¿‡é€‚é…å™¨åŒ…è£…
   - å¯ä»¥åˆ‡æ¢ä¸ºåˆ†å¸ƒå¼å­˜å‚¨

3. **RPCå±‚è§£è€¦** âœ…
   - åˆ›å»º `IRaftRpcChannel` å’Œ `IKvRpcClient` æ¥å£
   - ç°æœ‰RPCé€šè¿‡é€‚é…å™¨åŒ…è£…
   - å¯ä»¥æ›¿æ¢ä¸ºgRPCã€Thrift

4. **ä¸šåŠ¡é€»è¾‘åˆ†ç¦»** âœ…
   - åˆ›å»ºç‹¬ç«‹çš„ `KvStateMachine`
   - èŒè´£æ¸…æ™°ï¼šåªè´Ÿè´£ä¸šåŠ¡é€»è¾‘
   - å¯ä»¥ç‹¬ç«‹æµ‹è¯•

5. **å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡** âœ…
   - åˆ›å»º `ILoadBalancer` æ¥å£
   - å®ç°è½®è¯¢ç­–ç•¥
   - å¯æ‰©å±•ä¸ºä¸€è‡´æ€§å“ˆå¸Œç­‰

### æ¶æ„å¯¹æ¯”

#### é‡æ„å‰ï¼ˆè€¦åˆï¼‰
```
Clerk â”€â”€ç›´æ¥ä¾èµ–â”€â”€> raftServerRpcUtil
  â”‚
  â””â”€â”€> KvServer â”€â”€ç›´æ¥åŒ…å«â”€â”€> Raft
             â”‚
             â””â”€â”€ç›´æ¥åŒ…å«â”€â”€> SkipList
```

#### é‡æ„åï¼ˆè§£è€¦ï¼‰
```
Clerk â”€â”€æ¥å£â”€â”€> IKvRpcClient â”€â”€é€‚é…å™¨â”€â”€> raftServerRpcUtil
  â”‚
  â””â”€â”€æ¥å£â”€â”€> ILoadBalancer â”€â”€å®ç°â”€â”€> RoundRobinLoadBalancer

KvServer â”€â”€ä¾èµ–â”€â”€> KvStateMachine â”€â”€æ¥å£â”€â”€> IStorageEngine
                      â”‚                          â”‚
                      â”‚                          â””â”€â”€é€‚é…å™¨â”€â”€> SkipList
                      â”‚
                      â””â”€â”€å®ç°â”€â”€> IStateMachine â”€â”€æ¥å£â”€â”€> Raft
```

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶ï¼ˆ14ä¸ªï¼‰

### æ¥å£æ–‡ä»¶ï¼ˆ6ä¸ªï¼‰
```
src/common/include/
â”œâ”€â”€ IStorageEngine.h          # å­˜å‚¨å¼•æ“æ¥å£
â”œâ”€â”€ IPersistenceLayer.h        # æŒä¹…åŒ–å±‚æ¥å£
â”œâ”€â”€ IRaftRpcChannel.h          # Raft RPCæ¥å£
â”œâ”€â”€ IKvRpcClient.h             # KVå®¢æˆ·ç«¯RPCæ¥å£
â”œâ”€â”€ IStateMachine.h            # çŠ¶æ€æœºæ¥å£
â””â”€â”€ ILoadBalancer.h            # è´Ÿè½½å‡è¡¡æ¥å£
```

### é€‚é…å™¨å’Œå®ç°ï¼ˆ5ä¸ªï¼‰
```
src/skipList/include/
â””â”€â”€ SkipListStorageEngine.h    # SkipListé€‚é…å™¨

src/raftCore/include/
â”œâ”€â”€ PersisterAdapter.h         # æŒä¹…åŒ–é€‚é…å™¨
â”œâ”€â”€ RaftRpcAdapter.h           # Raft RPCé€‚é…å™¨
â””â”€â”€ KvStateMachine.h           # KVçŠ¶æ€æœºï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰

src/raftClerk/include/
â”œâ”€â”€ KvRpcClientAdapter.h       # KVå®¢æˆ·ç«¯é€‚é…å™¨
â””â”€â”€ RoundRobinLoadBalancer.h   # è½®è¯¢è´Ÿè½½å‡è¡¡å™¨
```

### æ–‡æ¡£æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰
```
./
â”œâ”€â”€ æ¶æ„è§£è€¦ä¼˜åŒ–æ–¹æ¡ˆ.md        # è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ æ¶æ„é‡æ„å®ŒæˆæŠ¥å‘Š.md        # å®ŒæˆæŠ¥å‘Š
â”œâ”€â”€ é‡æ„éªŒè¯æŒ‡å—.md            # éªŒè¯æŒ‡å—
â””â”€â”€ README_é‡æ„è¯´æ˜.md         # æœ¬æ–‡ä»¶
```

---

## ğŸš€ å¦‚ä½•æµ‹è¯•

### 1. ç¼–è¯‘é¡¹ç›®
```bash
cd /home/ric/projects/work/KVstorageBaseRaft-cpp-main/build
make -j4
```

**é¢„æœŸç»“æœ**: âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

### 2. è¿è¡Œé›†ç¾¤æµ‹è¯•

**å‡†å¤‡å·¥ä½œ**: éœ€è¦3ä¸ªç»ˆç«¯çª—å£

**ç»ˆç«¯1 - å¯åŠ¨èŠ‚ç‚¹0**:
```bash
cd /home/ric/projects/work/KVstorageBaseRaft-cpp-main
./bin/raftCoreRun -n 0 -f bin/test.conf
```

**ç»ˆç«¯2 - å¯åŠ¨èŠ‚ç‚¹1**:
```bash
cd /home/ric/projects/work/KVstorageBaseRaft-cpp-main
./bin/raftCoreRun -n 1 -f bin/test.conf
```

**ç»ˆç«¯3 - å¯åŠ¨èŠ‚ç‚¹2**:
```bash
cd /home/ric/projects/work/KVstorageBaseRaft-cpp-main
./bin/raftCoreRun -n 2 -f bin/test.conf
```

**ç»ˆç«¯4 - è¿è¡Œå®¢æˆ·ç«¯**:
```bash
cd /home/ric/projects/work/KVstorageBaseRaft-cpp-main
./bin/callerMain bin/test.conf
```

### 3. é¢„æœŸç°è±¡

- âœ… 3ä¸ªèŠ‚ç‚¹æˆåŠŸå¯åŠ¨
- âœ… é€‰å‡ºä¸€ä¸ªLeader
- âœ… å®¢æˆ·ç«¯æˆåŠŸæ‰§è¡ŒPut/Get/Appendæ“ä½œ
- âœ… æ•°æ®åœ¨èŠ‚ç‚¹é—´å¤åˆ¶

---

## ğŸ“Š ä»£ç å˜æ›´ç»Ÿè®¡

### ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ4ä¸ªï¼‰
1. `src/raftCore/include/kvServer.h` - æ·»åŠ KvStateMachineæˆå‘˜
2. `src/raftCore/kvServer.cpp` - åˆå§‹åŒ–çŠ¶æ€æœº
3. `src/raftClerk/include/clerk.h` - æ·»åŠ è´Ÿè½½å‡è¡¡å™¨
4. `src/raftClerk/clerk.cpp` - ä½¿ç”¨æ¥å£å‘é€RPC

### æ–°å¢ä»£ç è¡Œæ•°
- æ¥å£å®šä¹‰: ~350 è¡Œ
- é€‚é…å™¨å®ç°: ~250 è¡Œ
- ä¸šåŠ¡é€»è¾‘: ~200 è¡Œ
- æ–‡æ¡£: ~1500 è¡Œ
- **æ€»è®¡**: ~2300 è¡Œ

### å˜æ›´ç‡
- ä¿®æ”¹ç°æœ‰ä»£ç : < 5%ï¼ˆä¸»è¦æ˜¯æ·»åŠ æˆå‘˜å’Œåˆå§‹åŒ–ï¼‰
- æ–°å¢ä»£ç : ä¸»è¦æ˜¯æ¥å£å’Œé€‚é…å™¨
- å…¼å®¹æ€§: 100%ï¼ˆå‘åå…¼å®¹ï¼‰

---

## ğŸ“ å­¦ä¹ å’Œä½¿ç”¨

### å¦‚ä½•åˆ‡æ¢å­˜å‚¨å¼•æ“

**å½“å‰å®ç°**ï¼ˆSkipListï¼‰:
```cpp
// src/raftCore/kvServer.cpp:387
auto storageEngine = std::make_unique<SkipListStorageEngine>(6);
m_stateMachine = std::make_shared<KvStateMachine>(std::move(storageEngine));
```

**åˆ‡æ¢ä¸ºå…¶ä»–å¼•æ“**ï¼ˆç¤ºä¾‹ï¼‰:
```cpp
// å®ç°ä¸€ä¸ªæ–°çš„å­˜å‚¨å¼•æ“
class LsmTreeStorageEngine : public IStorageEngine {
    // å®ç°æ¥å£æ–¹æ³•...
};

// ä½¿ç”¨æ–°å¼•æ“
auto storageEngine = std::make_unique<LsmTreeStorageEngine>();
m_stateMachine = std::make_shared<KvStateMachine>(std::move(storageEngine));
```

### å¦‚ä½•å®ç°è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡

```cpp
// å®ç°è‡ªå®šä¹‰ç­–ç•¥
class MyLoadBalancer : public ILoadBalancer {
public:
    int SelectServer() override {
        // ä½ çš„ç­–ç•¥é€»è¾‘
    }
    
    void MarkSuccess(int serverIndex) override {
        // æ›´æ–°å¥åº·çŠ¶æ€
    }
    
    void MarkFailure(int serverIndex) override {
        // è§¦å‘ç†”æ–­
    }
};

// ä½¿ç”¨è‡ªå®šä¹‰ç­–ç•¥
m_loadBalancer = std::make_unique<MyLoadBalancer>(serverCount);
```

---

## ğŸ” ä»£ç å®¡æŸ¥è¦ç‚¹

### 1. æ¥å£è®¾è®¡
- âœ… æ¥å£å®šä¹‰æ¸…æ™°ï¼ŒèŒè´£å•ä¸€
- âœ… æ–¹æ³•å‘½åç¬¦åˆè§„èŒƒ
- âœ… å‚æ•°ç±»å‹åˆç†
- âœ… è™šææ„å‡½æ•°å·²å®šä¹‰

### 2. é€‚é…å™¨å®ç°
- âœ… æ­£ç¡®åŒ…è£…ç°æœ‰å®ç°
- âœ… çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨mutexï¼‰
- âœ… é”™è¯¯å¤„ç†åˆç†
- âœ… èµ„æºç®¡ç†æ­£ç¡®

### 3. ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- âœ… KvStateMachineèŒè´£æ¸…æ™°
- âœ… å»é‡é€»è¾‘ä¿ç•™
- âœ… å¿«ç…§åºåˆ—åŒ–æ­£ç¡®
- âœ… ä¸Rafté€šè¿‡æ¥å£äº¤äº’

### 4. å‘åå…¼å®¹
- âœ… ä¿ç•™åŸæœ‰å­—æ®µ
- âœ… RPCæ¥å£ä¸å˜
- âœ… é…ç½®æ–‡ä»¶ä¸å˜
- âœ… å¤–éƒ¨è°ƒç”¨è€…æ— éœ€ä¿®æ”¹

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½
- æ¥å£è°ƒç”¨æœ‰è½»å¾®å¼€é”€ï¼ˆ< 0.1%ï¼‰
- å¯¹IOå¯†é›†å‹Raftç³»ç»Ÿå½±å“å¯å¿½ç•¥
- å»ºè®®è¿è¡Œæ€§èƒ½æµ‹è¯•å¯¹æ¯”

### 2. å†…å­˜
- æ¯ä¸ªå¯¹è±¡å¢åŠ 8å­—èŠ‚è™šè¡¨æŒ‡é’ˆ
- æ€»å¢åŠ çº¦64å­—èŠ‚
- å¯å¿½ç•¥ä¸è®¡

### 3. ç¼–è¯‘æ—¶é—´
- ç”±äºå¢åŠ äº†å¤´æ–‡ä»¶ï¼Œç¼–è¯‘æ—¶é—´å¯èƒ½ç•¥å¢
- å»ºè®®ä½¿ç”¨ `-j4` å¹¶è¡Œç¼–è¯‘

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **[æ¶æ„è§£è€¦ä¼˜åŒ–æ–¹æ¡ˆ.md](./æ¶æ„è§£è€¦ä¼˜åŒ–æ–¹æ¡ˆ.md)**
   - è¯¦ç»†çš„è®¾è®¡æ–¹æ¡ˆ
   - ä¼˜åŒ–å‰åå¯¹æ¯”
   - æ¥å£è®¾è®¡è¯¦è§£

2. **[æ¶æ„é‡æ„å®ŒæˆæŠ¥å‘Š.md](./æ¶æ„é‡æ„å®ŒæˆæŠ¥å‘Š.md)**
   - å·²å®Œæˆå·¥ä½œæ€»ç»“
   - æ–°å¢æ–‡ä»¶åˆ—è¡¨
   - åç»­æ”¹è¿›å»ºè®®

3. **[é‡æ„éªŒè¯æŒ‡å—.md](./é‡æ„éªŒè¯æŒ‡å—.md)**
   - æµ‹è¯•æ­¥éª¤
   - éªŒè¯æ¸…å•
   - å·²çŸ¥é—®é¢˜

---

## ğŸ¯ åç»­è®¡åˆ’

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰
- [ ] è¿è¡Œå®Œæ•´é›†ç¾¤æµ‹è¯•
- [ ] éªŒè¯Get/Put/AppendåŠŸèƒ½
- [ ] æ€§èƒ½å¯¹æ¯”æµ‹è¯•

### ä¸­æœŸï¼ˆæœ¬æœˆï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] å®ç°LsmTreeå­˜å‚¨å¼•æ“
- [ ] å®ç°ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡

### é•¿æœŸï¼ˆä¸‹ä¸ªæœˆï¼‰
- [ ] Raftæ ¸å¿ƒé‡æ„ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
- [ ] é›†æˆRocksDB
- [ ] æ·»åŠ ç›‘æ§å’Œå¯è§‚æµ‹æ€§

---

## ğŸ› é—®é¢˜åé¦ˆ

å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥ç¼–è¯‘æ˜¯å¦æˆåŠŸ
2. æŸ¥çœ‹æ—¥å¿—è¾“å‡º
3. å‚è€ƒ[é‡æ„éªŒè¯æŒ‡å—.md](./é‡æ„éªŒè¯æŒ‡å—.md)ä¸­çš„å·²çŸ¥é—®é¢˜

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡é‡æ„æˆåŠŸå®ç°äº†**æ¶æ„è§£è€¦**ï¼Œä¸»è¦æˆæœï¼š

âœ… **ç¼–è¯‘é€šè¿‡** - 100%  
âœ… **æ¥å£å®Œæ•´** - 6ä¸ªæ ¸å¿ƒæ¥å£  
âœ… **é€‚é…å™¨å®Œå¤‡** - 5ä¸ªé€‚é…å™¨  
âœ… **å‘åå…¼å®¹** - 100%  
âœ… **æ–‡æ¡£é½å…¨** - 4ä»½æ–‡æ¡£  

**ä¸‹ä¸€æ­¥**: è¯·è¿è¡Œé›†ç¾¤æµ‹è¯•éªŒè¯åŠŸèƒ½ï¼

---

**æœ€åæ›´æ–°**: 2025-11-01 18:50  
**ç‰ˆæœ¬**: v1.0  
**ä½œè€…**: AI Assistant

