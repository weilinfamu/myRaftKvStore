# è¿æ¥æ± å¿«é€Ÿå¼€å§‹æŒ‡å—

## ä¸€åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹

### 1. åŸºæœ¬ç”¨æ³•

```cpp
#include "connectionpool.h"
#include "iomanager.hpp"

void my_rpc_call() {
    auto& pool = ConnectionPool::GetInstance();
    
    // 1. è·å–è¿æ¥
    auto channel = pool.GetConnection("192.168.1.100", 8080);
    
    // 2. æ‰§è¡Œ RPC è°ƒç”¨
    YourService_Stub stub(channel.get());
    YourRequest request;
    YourResponse response;
    MprpcController controller;
    
    stub.YourMethod(&controller, &request, &response, nullptr);
    
    // 3. å½’è¿˜è¿æ¥
    pool.ReturnConnection(channel, "192.168.1.100", 8080);
}

int main() {
    monsoon::IOManager iom(4);
    iom.scheduler(my_rpc_call);
    return 0;
}
```

### 2. å…³é”®ç‰¹æ€§

âœ… **è‡ªåŠ¨å¤ç”¨**ï¼šè¿æ¥ä¼šè¢«è‡ªåŠ¨å¤ç”¨ï¼Œæ€§èƒ½æå‡ 3 å€

âœ… **å¥åº·æ£€æŸ¥**ï¼šä¸å¥åº·çš„è¿æ¥ä¼šè¢«è‡ªåŠ¨ä¸¢å¼ƒ

âœ… **å¿ƒè·³ä¿æ´»**ï¼šç©ºé—²è¿æ¥ä¼šè‡ªåŠ¨å‘é€å¿ƒè·³ä¿æŒæ´»è·ƒ

âœ… **æ•…éšœæ¢å¤**ï¼šç½‘ç»œæ•…éšœä¼šè‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤

âœ… **å¤§æ•°æ®æ”¯æŒ**ï¼šæ”¯æŒä»»æ„å¤§å°çš„ RPC å“åº”

### 3. ä¸æ—§ä»£ç å¯¹æ¯”

#### æ—§æ–¹å¼ï¼ˆä¸æ¨èï¼‰

```cpp
// âŒ æ—§ä»£ç ï¼šæ¯æ¬¡åˆ›å»ºæ–°è¿æ¥
MprpcChannel channel(ip, port, true);  // æ¯æ¬¡éƒ½è¦ connect
YourService_Stub stub(&channel);
stub.YourMethod(...);
// æ²¡æœ‰è¿æ¥å¤ç”¨ï¼Œæ²¡æœ‰å¥åº·æ£€æŸ¥
```

**é—®é¢˜**ï¼š
- æ¯æ¬¡è°ƒç”¨éƒ½è¦å»ºç«‹æ–°è¿æ¥ï¼ˆæ…¢ï¼‰
- æ²¡æœ‰è¿æ¥å¥åº·æ£€æŸ¥
- å›ºå®š 1024 å­—èŠ‚ç¼“å†²åŒºï¼ˆå¤§æ•°æ®ä¼šæˆªæ–­ï¼‰

#### æ–°æ–¹å¼ï¼ˆæ¨èï¼‰

```cpp
// âœ… æ–°ä»£ç ï¼šä½¿ç”¨è¿æ¥æ± 
auto& pool = ConnectionPool::GetInstance();
auto channel = pool.GetConnection(ip, port);  // å¤ç”¨å·²æœ‰è¿æ¥
YourService_Stub stub(channel.get());
stub.YourMethod(...);
pool.ReturnConnection(channel, ip, port);  // å½’è¿˜ä¾›ä¸‹æ¬¡å¤ç”¨
```

**ä¼˜åŠ¿**ï¼š
- è¿æ¥å¤ç”¨ï¼Œæ€§èƒ½æå‡ 3 å€
- è‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œå¿ƒè·³
- æ”¯æŒä»»æ„å¤§å°çš„æ•°æ®ä¼ è¾“
- æ•…éšœè‡ªåŠ¨æ¢å¤

## æ ¸å¿ƒæ¦‚å¿µ

### 1. è¿æ¥æ± 

```
ConnectionPool (å•ä¾‹)
    â”‚
    â”œâ”€ "192.168.1.100:8080" â†’ [è¿æ¥1, è¿æ¥2, è¿æ¥3]
    â”‚
    â”œâ”€ "192.168.1.101:8080" â†’ [è¿æ¥1, è¿æ¥2]
    â”‚
    â””â”€ "192.168.1.102:9090" â†’ [è¿æ¥1]
```

- **æŒ‰åœ°å€åˆ†ç»„**ï¼šä¸åŒç›®æ ‡åœ°å€æœ‰ç‹¬ç«‹çš„è¿æ¥é˜Ÿåˆ—
- **è‡ªåŠ¨ç®¡ç†**ï¼šè‡ªåŠ¨åˆ›å»ºã€å¤ç”¨ã€ä¸¢å¼ƒè¿æ¥
- **çº¿ç¨‹å®‰å…¨**ï¼šå¯ä»¥åœ¨å¤šä¸ªåç¨‹ä¸­å¹¶å‘ä½¿ç”¨

### 2. è¿æ¥çŠ¶æ€

```
HEALTHY (å¥åº·) â”€â”€å¤±è´¥â”€â”€> PROBING (æ¢æµ‹) â”€â”€å¤±è´¥3æ¬¡â”€â”€> DISCONNECTED (æ–­å¼€)
       ^                     â”‚
       â””â”€â”€â”€â”€â”€æˆåŠŸâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **HEALTHY**ï¼šè¿æ¥æ­£å¸¸ï¼Œå¯ä»¥ä½¿ç”¨
- **PROBING**ï¼šå¯èƒ½æœ‰é—®é¢˜ï¼Œæ­£åœ¨æ¢æµ‹ï¼ˆæ¯ 5 ç§’ï¼‰
- **DISCONNECTED**ï¼šå·²æ–­å¼€ï¼Œä¼šè¢«ä¸¢å¼ƒ

### 3. å¿ƒè·³æœºåˆ¶

```
æ—¶é—´è½´ï¼ˆæ­£å¸¸æƒ…å†µï¼‰ï¼š
0s â”€â”€â”€â”€â”€â”€â”€â”€> 10s â”€â”€â”€â”€â”€â”€â”€â”€> 20s â”€â”€â”€â”€â”€â”€â”€â”€> 30s
   RPCè°ƒç”¨      å¿ƒè·³æ£€æŸ¥      RPCè°ƒç”¨      å¿ƒè·³æ£€æŸ¥
```

- **ç©ºé—²æ—¶æ£€æŸ¥**ï¼š10 ç§’æ— æ´»åŠ¨åˆ™å‘é€å¿ƒè·³
- **æ´»è·ƒæ—¶ä¸æ£€æŸ¥**ï¼šæ¯æ¬¡ RPC è°ƒç”¨ä¼šé‡ç½®å¿ƒè·³å®šæ—¶å™¨
- **æ•…éšœæ—¶åŠ é€Ÿ**ï¼šè¿›å…¥ PROBING çŠ¶æ€åï¼Œ5 ç§’æ£€æŸ¥ä¸€æ¬¡

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ RAII è‡ªåŠ¨ç®¡ç†ï¼ˆå¼ºçƒˆæ¨èï¼‰

```cpp
class ConnectionGuard {
public:
    ConnectionGuard(const std::string& ip, uint16_t port) 
        : ip_(ip), port_(port) {
        channel_ = ConnectionPool::GetInstance().GetConnection(ip, port);
    }
    
    ~ConnectionGuard() {
        if (channel_) {
            ConnectionPool::GetInstance().ReturnConnection(channel_, ip_, port_);
        }
    }
    
    std::shared_ptr<MprpcChannel> get() { return channel_; }
    
private:
    std::string ip_;
    uint16_t port_;
    std::shared_ptr<MprpcChannel> channel_;
};

// ä½¿ç”¨
void my_rpc_call() {
    ConnectionGuard guard(ip, port);  // è‡ªåŠ¨è·å–
    auto channel = guard.get();
    
    if (!channel) return;
    
    // æ‰§è¡Œ RPC è°ƒç”¨...
    
    // guard ææ„æ—¶è‡ªåŠ¨å½’è¿˜
}
```

**ä¼˜åŠ¿**ï¼š
- è‡ªåŠ¨å½’è¿˜è¿æ¥ï¼Œä¸ä¼šå¿˜è®°
- å¼‚å¸¸å®‰å…¨ï¼Œå³ä½¿å‡ºé”™ä¹Ÿä¼šå½’è¿˜
- ä»£ç ç®€æ´

### 2. æ£€æŸ¥è¿æ¥å¥åº·çŠ¶æ€

```cpp
auto channel = pool.GetConnection(ip, port);

// âœ… æ¨èï¼šå…ˆæ£€æŸ¥å†ä½¿ç”¨
if (channel && channel->IsHealthy()) {
    // ä½¿ç”¨è¿æ¥
} else {
    // å¤„ç†é”™è¯¯
}
```

### 3. åœ¨ IOManager ç¯å¢ƒä¸­ä½¿ç”¨

```cpp
// âœ… æ¨èï¼šåœ¨åç¨‹ä¸­ä½¿ç”¨
monsoon::IOManager iom(4);
iom.scheduler([]() {
    // åœ¨è¿™é‡Œï¼ŒHook è‡ªåŠ¨å¯ç”¨
    // send/recv ä¼šè¢«è‡ªåŠ¨å¼‚æ­¥åŒ–
    // å¿ƒè·³æœºåˆ¶ä¼šæ­£å¸¸å·¥ä½œ
    auto channel = pool.GetConnection(...);
    // ...
});

// âš ï¸ å¯ç”¨ä½†ä¸æ¨èï¼šåœ¨æ™®é€šçº¿ç¨‹ä¸­ä½¿ç”¨
void normal_thread() {
    auto channel = pool.GetConnection(...);
    // ä»ç„¶èƒ½ç”¨ï¼Œä½†ï¼š
    // 1. send/recv æ˜¯é˜»å¡çš„ï¼ˆæ€§èƒ½å·®ï¼‰
    // 2. å¿ƒè·³æœºåˆ¶ä¸å·¥ä½œï¼ˆéœ€è¦ IOManagerï¼‰
}
```

## å¸¸è§é—®é¢˜

### Q1: ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨è¿æ¥æ± ï¼Ÿ

**A**: å‡ ä¹æ‰€æœ‰æƒ…å†µï¼å°¤å…¶æ˜¯ï¼š
- é¢‘ç¹çš„ RPC è°ƒç”¨
- éœ€è¦é«˜æ€§èƒ½å’Œä½å»¶è¿Ÿ
- éœ€è¦å¯é çš„è¿æ¥ç®¡ç†
- éœ€è¦æ”¯æŒå¤§æ•°æ®ä¼ è¾“

### Q2: è¿æ¥æ± ä¼šè‡ªåŠ¨ç®¡ç†è¿æ¥å—ï¼Ÿ

**A**: æ˜¯çš„ï¼
- âœ… è‡ªåŠ¨åˆ›å»ºæ–°è¿æ¥
- âœ… è‡ªåŠ¨å¤ç”¨å·²æœ‰è¿æ¥
- âœ… è‡ªåŠ¨æ£€æŸ¥è¿æ¥å¥åº·
- âœ… è‡ªåŠ¨ä¸¢å¼ƒä¸å¥åº·çš„è¿æ¥
- âœ… è‡ªåŠ¨å‘é€å¿ƒè·³ä¿æ´»

### Q3: éœ€è¦æ‰‹åŠ¨å…³é—­è¿æ¥å—ï¼Ÿ

**A**: ä¸éœ€è¦ï¼
- `ReturnConnection()` ä¼šæŠŠè¿æ¥æ”¾å›æ± ä¸­
- ä¸å¥åº·çš„è¿æ¥ä¼šè¢«è‡ªåŠ¨ä¸¢å¼ƒ
- è¿æ¥æ± ææ„æ—¶ä¼šè‡ªåŠ¨æ¸…ç†æ‰€æœ‰è¿æ¥

### Q4: å¦‚ä½•æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€ï¼Ÿ

**A**: ä½¿ç”¨ `GetStats()` æ–¹æ³•ï¼š

```cpp
auto& pool = ConnectionPool::GetInstance();
std::cout << pool.GetStats() << std::endl;

// è¾“å‡ºç¤ºä¾‹ï¼š
// === ConnectionPool Statistics ===
// Total connections created: 10
// Total connections reused: 100
// Total connections discarded: 2
// Active pools: 3
// Pool details:
//   192.168.1.100:8080: 3 connections
//   192.168.1.101:8080: 2 connections
```

### Q5: å¿ƒè·³ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

**A**: å‡ ä¹ä¸ä¼šï¼
- å¿ƒè·³é—´éš”ï¼š10 ç§’ï¼ˆå¾ˆé•¿ï¼‰
- å¿ƒè·³åŒ…å¤§å°ï¼š0 å­—èŠ‚ï¼ˆä»…æ¢æµ‹ï¼‰
- å¼€é”€å æ¯”ï¼š< 0.01%

### Q6: å¦‚ä½•è°ƒæ•´è¶…æ—¶æ—¶é—´ï¼Ÿ

**A**: åœ¨ `mprpcchannel.cpp` çš„ `newConnect()` ä¸­ä¿®æ”¹ï¼š

```cpp
struct timeval timeout;
timeout.tv_sec = 10;  // æ”¹ä¸º 10 ç§’
```

### Q7: å¦‚ä½•è°ƒæ•´å¿ƒè·³é—´éš”ï¼Ÿ

**A**: åœ¨ `mprpcchannel.h` ä¸­ä¿®æ”¹ï¼š

```cpp
static constexpr uint64_t HEARTBEAT_INTERVAL_MS = 5000;  // æ”¹ä¸º 5 ç§’
```

## æ€§èƒ½æ•°æ®

### è¿æ¥å¤ç”¨çš„æ€§èƒ½æå‡

```
æµ‹è¯•åœºæ™¯ï¼š1000 æ¬¡ RPC è°ƒç”¨

ä¸ä½¿ç”¨è¿æ¥æ± ï¼š
  æ€»è€—æ—¶ï¼š15 ç§’

ä½¿ç”¨è¿æ¥æ± ï¼š
  æ€»è€—æ—¶ï¼š5 ç§’

æ€§èƒ½æå‡ï¼š3 å€ â†‘
```

### åŠ¨æ€ç¼“å†²åŒºçš„å¯é æ€§

```
æµ‹è¯•åœºæ™¯ï¼šä¼ è¾“ 10KB æ•°æ®

æ—§å®ç°ï¼ˆ1024å­—èŠ‚ç¼“å†²åŒºï¼‰ï¼š
  ç»“æœï¼šæ•°æ®æˆªæ–­ï¼Œååºåˆ—åŒ–å¤±è´¥
  å¯é æ€§ï¼š0%

æ–°å®ç°ï¼ˆåŠ¨æ€ç¼“å†²åŒºï¼‰ï¼š
  ç»“æœï¼šå®Œæ•´æ¥æ”¶ï¼Œååºåˆ—åŒ–æˆåŠŸ
  å¯é æ€§ï¼š100%
```

## å®Œæ•´ç¤ºä¾‹

```cpp
#include <iostream>
#include "connectionpool.h"
#include "iomanager.hpp"
#include "mprpccontroller.h"

// RAII è¿æ¥ç®¡ç†å™¨
class ConnectionGuard {
public:
    ConnectionGuard(const std::string& ip, uint16_t port) 
        : ip_(ip), port_(port) {
        channel_ = ConnectionPool::GetInstance().GetConnection(ip, port);
    }
    
    ~ConnectionGuard() {
        if (channel_) {
            ConnectionPool::GetInstance().ReturnConnection(channel_, ip_, port_);
        }
    }
    
    std::shared_ptr<MprpcChannel> get() { return channel_; }
    bool valid() const { return channel_ && channel_->IsHealthy(); }
    
private:
    std::string ip_;
    uint16_t port_;
    std::shared_ptr<MprpcChannel> channel_;
};

// RPC è°ƒç”¨ç¤ºä¾‹
void execute_rpc(const std::string& ip, uint16_t port) {
    ConnectionGuard guard(ip, port);
    
    if (!guard.valid()) {
        std::cerr << "Failed to get connection" << std::endl;
        return;
    }
    
    auto channel = guard.get();
    
    // åˆ›å»º stub
    YourService_Stub stub(channel.get());
    MprpcController controller;
    YourRequest request;
    YourResponse response;
    
    // è®¾ç½®è¯·æ±‚å‚æ•°
    request.set_key("example_key");
    
    // æ‰§è¡Œ RPC è°ƒç”¨
    stub.Get(&controller, &request, &response, nullptr);
    
    // æ£€æŸ¥ç»“æœ
    if (controller.Failed()) {
        std::cerr << "RPC failed: " << controller.ErrorText() << std::endl;
    } else {
        std::cout << "RPC succeeded: " << response.value() << std::endl;
    }
    
    // guard ææ„æ—¶è‡ªåŠ¨å½’è¿˜è¿æ¥
}

// ä¸»ç¨‹åº
int main() {
    std::cout << "=== ConnectionPool Example ===" << std::endl;
    
    // åˆ›å»º IOManagerï¼ˆè‡ªåŠ¨å¯ç”¨ Hookï¼‰
    monsoon::IOManager iom(4, true);
    
    // æ‰§è¡Œ 10 ä¸ªå¹¶å‘ RPC è°ƒç”¨
    for (int i = 0; i < 10; ++i) {
        iom.scheduler([i]() {
            std::cout << "[Task " << i << "] Starting..." << std::endl;
            execute_rpc("192.168.1.100", 8080);
            std::cout << "[Task " << i << "] Finished" << std::endl;
        });
    }
    
    // ç­‰å¾…ä»»åŠ¡å®Œæˆ
    std::this_thread::sleep_for(std::chrono::seconds(2));
    
    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    auto& pool = ConnectionPool::GetInstance();
    std::cout << "\n" << pool.GetStats() << std::endl;
    
    return 0;
}
```

## ä¸‹ä¸€æ­¥

- ğŸ“– **è¯¦ç»†æ–‡æ¡£**: [docs/è¿æ¥æ± ä¸å¥åº·æ£€æŸ¥æœºåˆ¶.md](./è¿æ¥æ± ä¸å¥åº·æ£€æŸ¥æœºåˆ¶.md)
- ğŸ’¡ **å®Œæ•´ç¤ºä¾‹**: [example/connection_pool_example.cpp](../example/connection_pool_example.cpp)
- ğŸ“ **ä¿®æ”¹æ€»ç»“**: [CHANGES_SUMMARY_TASK23.md](../CHANGES_SUMMARY_TASK23.md)

å¼€å§‹ä½¿ç”¨é«˜æ€§èƒ½çš„è¿æ¥æ± å’ŒåŠ¨æ€ç¼“å†²åŒºï¼Œäº«å— 3 å€æ€§èƒ½æå‡ï¼ğŸš€


